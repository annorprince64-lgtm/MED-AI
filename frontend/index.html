<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRUGBOT - Medical Assistant</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
        --primary-color: #10a37f;
        --primary-dark: #0d8c6c;
        --sidebar-bg: #202123;
        --chat-bg: #343541;
        --message-user-bg: #10a37f;
        --message-ai-bg: #444654;
        --text-color: #d1d5db;
        --text-light: #9ca3af;
        --border-color: #4b5563;
        --hover-color: #2d2d3a;
    }

    body {
        background-color: var(--chat-bg);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        overflow: hidden;
    }

    /* Sidebar Toggle */
    .sidebar-toggle {
        display: none;
        position: absolute;
        top: 12px;
        left: 12px;
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.2rem;
        cursor: pointer;
        z-index: 20;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        align-items: center;
        justify-content: center;
    }

    .sidebar-toggle:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    @media (max-width: 768px) {
        .sidebar-toggle {
            display: flex;
        }
        
        .sidebar {
            position: fixed;
            transform: translateX(-100%);
            height: 100vh;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .ai-table {
            display: block;
            overflow-x: auto;
        }

        .ai-table th,
        .ai-table td {
            padding: 8px 10px;
            font-size: 12px;
        }
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background-color: var(--sidebar-bg);
        display: flex;
        flex-direction: column;
        height: 100%;
        transition: transform 0.3s ease;
        z-index: 10;
        border-right: 1px solid var(--border-color);
    }

    .sidebar-header {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
    }

    .brand-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
    }

    .brand-text {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .new-chat-btn {
        margin: 20px;
        padding: 14px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .history-title {
        padding: 15px 12px 8px;
        font-size: 0.8rem;
        color: var(--text-light);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .history-item {
        padding: 12px 15px;
        border-radius: 10px;
        cursor: pointer;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid transparent;
    }

    .history-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .history-item.active {
        background: rgba(102, 126, 234, 0.15);
        border-color: rgba(102, 126, 234, 0.3);
    }

    .history-item-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        overflow: hidden;
    }

    .history-item-icon {
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: var(--text-color);
    }

    .history-item-title {
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 14px;
        font-weight: 500;
    }

    .history-item-time {
        font-size: 11px;
        color: var(--text-light);
        margin-top: 2px;
    }

    .sidebar-footer {
        padding: 15px;
        border-top: 1px solid var(--border-color);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.05);
    }

    .user-profile:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: white;
    }

    /* Main Chat Area */
    .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        width: 100%;
    }

    .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(0, 0, 0, 0.2);
    }

    .chat-title {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        position: relative;
    }

    .header-btn {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .header-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    #audioToggleBtn {
        position: relative;
    }

    #audioToggleBtn.audio-disabled {
        opacity: 0.5;
    }

    #audioToggleBtn.audio-disabled #audioToggleIcon::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        width: 2px;
        height: 20px;
        background-color: #ef4444;
    }

    /* Settings Menu */
    .settings-menu {
        display: none;
        position: absolute;
        top: 50px;
        right: 0;
        background: var(--sidebar-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        min-width: 200px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 100;
        overflow: hidden;
    }

    .settings-menu.show {
        display: block;
    }

    .settings-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-color);
    }

    .settings-item:hover {
        background: var(--hover-color);
    }

    .settings-divider {
        height: 1px;
        background: var(--border-color);
        margin: 8px 0;
    }

    .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .message {
        display: flex;
        gap: 15px;
        max-width: 100%;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user-message {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .user-message .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .ai-message .message-avatar {
        background: var(--primary-color);
    }

    .message-content {
        flex: 1;
        line-height: 1.6;
        max-width: 80%;
    }

    .message-content p {
        margin-bottom: 10px;
    }

    .message-content p:last-child {
        margin-bottom: 0;
    }

    .user-message .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 15px 20px;
        border-radius: 18px 18px 5px 18px;
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .ai-message .message-content {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px 20px;
        border-radius: 18px 18px 18px 5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .message:hover .message-actions {
        opacity: 1;
    }

    .action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 6px;
        color: var(--text-light);
        cursor: pointer;
        font-size: 0.9rem;
        padding: 6px 10px;
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-color);
    }

    .drug-recommendation {
        background: rgba(16, 163, 127, 0.1);
        padding: 12px 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid var(--primary-color);
    }

    .disclaimer {
        background: rgba(239, 68, 68, 0.1);
        padding: 12px 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid #ef4444;
        font-size: 0.9rem;
    }

    /* Input Area */
    .input-container {
        padding: 20px;
        border-top: 1px solid var(--border-color);
        background: rgba(0, 0, 0, 0.2);
        position: relative;
    }

    .input-wrapper {
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

 .chat-textarea {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 16px 60px 16px 20px;
    color: var(--text-color);
    font-size: 16px;
    line-height: 1.5;
    resize: none;
    min-height: 56px;
    max-height: 200px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow-y: auto; /* Changed from scroll to auto */
}
    .chat-textarea:focus {
        outline: none;
        border-color: #667eea;
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .chat-textarea::placeholder {
        color: var(--text-light);
    }

    .voice-input-btn {
        position: absolute;
        right: 70px;
        bottom: 16px;
        background: none;
        border: none;
        color: var(--text-light);
        cursor: pointer;
        font-size: 18px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .voice-input-btn:hover {
        color: var(--text-color);
        background: rgba(255, 255, 255, 0.1);
    }

    .voice-input-btn.listening {
        color: #ef4444;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .send-btn {
        position: absolute;
        right: 20px;
        bottom: 16px;
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .send-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

  

    .status-indicator {
        text-align: center;
        margin-top: 15px;
        font-size: 14px;
        color: var(--text-light);
        min-height: 20px;
    }

    .input-suggestions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .suggestion-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 8px 16px;
        color: var(--text-light);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .suggestion-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
        border-color: #667eea;
    }

    /* Modals */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        background: linear-gradient(135deg, rgba(32, 33, 35, 0.95), rgba(52, 53, 65, 0.95));
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        position: relative;
    }

    .modal-header {
        padding: 25px 30px 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
    }

    .modal-icon {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        margin-bottom: 15px;
        color: white;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .modal-subtitle {
        color: var(--text-light);
        font-size: 14px;
    }

    /* Modal close button - THIS WAS MISSING */
    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 10px;
        color: var(--text-color);
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 25px 30px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-light);
    }

    .form-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-color);
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        padding: 14px 28px;
        border-radius: 10px;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-block {
        width: 100%;
    }

    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid var(--border-color);
        text-align: center;
        color: var(--text-light);
        font-size: 14px;
    }

    .modal-footer a {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .modal-footer a:hover {
        text-decoration: underline;
    }

    /* AI Table Styles */
    .ai-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ai-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 12px 15px;
        text-align: left;
        font-size: 14px;
    }

    .ai-table td {
        padding: 10px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 14px;
    }

    .ai-table tr:last-child td {
        border-bottom: none;
    }

    .ai-table tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    /* Markdown Styles */
    .message-content h2:first-child,
    .message-content h3:first-child {
        margin-top: 0;
    }

    .message-content ul {
        list-style-type: disc;
        margin-left: 20px;
    }

    .message-content ol {
        list-style-type: decimal;
        margin-left: 20px;
    }

    .message-content h2,
    .message-content h3 {
        margin: 20px 0 10px 0;
        font-weight: 600;
    }

    .message-content h2 {
        font-size: 1.3em;
        border-bottom: 1px solid rgba(102, 126, 234, 0.3);
        padding-bottom: 5px;
        color: #667eea;
    }

    .message-content h3 {
        font-size: 1.1em;
        color: #a78bfa;
    }

    .message-content strong {
        color: #a78bfa;
        font-weight: 600;
    }

    .message-content em {
        color: #94a3b8;
        font-style: italic;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: inline-block;
        margin-left: 5px;
    }

    .typing-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--text-light);
        margin-right: 3px;
        animation: typing 1.4s infinite both;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% { opacity: 0.3; }
        30% { opacity: 1; }
    }

    /* Additional content styles */
    .policy-section {
        margin-bottom: 25px;
    }

    .policy-section h3 {
        color: var(--text-color);
        margin-bottom: 12px;
        font-size: 18px;
        font-weight: 600;
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        padding-bottom: 5px;
    }

    .policy-list {
        list-style: none;
        padding-left: 0;
    }

    .policy-list li {
        padding: 8px 0;
        color: var(--text-light);
        position: relative;
        padding-left: 25px;
    }

    .policy-list li::before {
        content: 'âœ“';
        color: #667eea;
        position: absolute;
        left: 0;
        font-weight: bold;
    }

    .contact-info {
        display: grid;
        gap: 15px;
        margin: 20px 0;
    }

    .contact-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 18px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .contact-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(102, 126, 234, 0.3);
        transform: translateX(5px);
    }

    .contact-icon {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
    }

    .contact-details h4 {
        font-size: 13px;
        color: var(--text-light);
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .contact-details p {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .chat-textarea {
            padding: 16px 50px 16px 16px;
            min-height: 52px;
        }

        .voice-input-btn {
            right: 60px;
            bottom: 14px;
        }

        .send-btn {
            right: 16px;
            bottom: 14px;
        }

        .input-language-selector {
            left: 16px;
            bottom: 14px;
            font-size: 12px;
        }

        .input-suggestions {
            gap: 8px;
        }

        .suggestion-btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal-content {
            width: 95%;
            margin: 10px;
        }

        .message-content {
            max-width: 90%;
        }
    }

    /* Remove old keyboard panel styles */
    .keyboard-panel,
    .keyboard-btn,
    .language-btn,
    .old-voice-btn {
        display: none !important;
    }
</style>
</head>

<body>
    <!-- Sidebar Toggle for Mobile -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="brand">
                <div class="brand-icon">
                    <i class="fas fa-pills"></i>
                </div>
                <div class="brand-text">DRUGBOT</div>
            </div>
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus-circle"></i>
            New Chat
        </button>

        <div class="chat-history" id="chatHistory">
            <div class="history-title">Today</div>
            <!-- History items will be populated by JavaScript -->
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="userName">Guest User</span>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-container">
        <div class="chat-header">
            <div class="chat-title">DRUGBOT</div>
            <div class="header-actions">
                <button class="header-btn" id="clearChatBtn" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="header-btn" id="settingsBtn" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn" id="audioToggleBtn" title="Toggle audio responses">
                    <i class="fas fa-volume-up" id="audioToggleIcon"></i>
                </button>
                <div class="settings-menu" id="settingsMenu">
                    <div class="settings-item" id="profileSettings">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </div>
                    <div class="settings-item" id="privacyPolicy">
                        <i class="fas fa-shield-alt"></i>
                        <span>Privacy Policy</span>
                    </div>
                    <div class="settings-item" id="contactUs">
                        <i class="fas fa-phone"></i>
                        <span>Contact Us</span>
                    </div>
                    <div class="settings-item" id="aboutUs">
                        <i class="fas fa-info-circle"></i>
                        <span>About Us</span>
                    </div>
                    <div class="settings-divider"></div>
                    <div class="settings-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>Hello! I'm <strong>DRUGBOT</strong>, your AI medical assistant. I can understand Twi and English
                        speech. I can help with medical questions, general knowledge, translations, and more.</p>
                    <p>Type your message in the box below or click the microphone button to speak.</p>
                </div>
            </div>
        </div>

           <!-- MODERN INPUT AREA -->
            <div class="input-container">
    <div class="input-wrapper">
        <!-- Main text input area -->
        <textarea class="chat-textarea" id="chatTextarea" 
            placeholder="Message DRUGBOT... (Shift+Enter for new line)"
            rows="1"></textarea>

        <!-- Voice button inside textarea -->
        <button class="voice-input-btn" id="voiceInputBtn" title="Voice input">
            <i class="fas fa-microphone"></i>
        </button>

        <!-- Send button -->
        <button class="send-btn" id="sendBtn" title="Send message">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>

    <!-- Quick suggestions -->
    <div class="input-suggestions">
        <button class="suggestion-btn" data-prompt="What are the symptoms of malaria?">Malaria symptoms</button>
        <button class="suggestion-btn" data-prompt="Recommend OTC pain relief">Pain relief</button>
        <button class="suggestion-btn" data-prompt="How to treat common cold?">Common cold</button>
        <button class="suggestion-btn" data-prompt="First aid for burns">First aid burns</button>
    </div>

    <div class="status-indicator" id="statusIndicator">Ready to chat - Type or speak your message</div>
</div>

    <!-- ALL MODALS MUST BE HERE -->
    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-lock"></i>
                </div>
                <h2 class="modal-title">Login to DRUGBOT</h2>
                <p class="modal-subtitle">Access your medical assistant account</p>
                <button class="modal-close" id="closeLoginModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email Address</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i>
                        Login
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                Don't have an account? <a href="#" id="showRegister">Register here</a>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h2 class="modal-title">Create Account</h2>
                <p class="modal-subtitle">Join DRUGBOT today</p>
                <button class="modal-close" id="closeRegisterModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label" for="registerName">Full Name</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email Address</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerConfirmPassword">Confirm Password</label>
                        <input type="password" class="form-input" id="registerConfirmPassword" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-user-plus"></i>
                        Register
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                Already have an account? <a href="#" id="showLogin">Login here</a>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-cog"></i>
                </div>
                <h2 class="modal-title">User Profile</h2>
                <p class="modal-subtitle">Manage your account settings</p>
                <button class="modal-close" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="profileError" style="display: none; color: #ef4444; margin-bottom: 15px; padding: 10px; background: rgba(239,68,68,0.1); border-radius: 8px;"></div>
                <div id="profileSuccess" style="display: none; color: #10a37f; margin-bottom: 15px; padding: 10px; background: rgba(16,163,127,0.1); border-radius: 8px;"></div>
                
                <div class="form-group">
                    <label class="form-label" for="profileName">Full Name</label>
                    <input type="text" class="form-input" id="profileName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="profileEmail">Email Address</label>
                    <input type="email" class="form-input" id="profileEmail" placeholder="Enter your email">
                </div>
                
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="color: var(--text-color); margin-bottom: 15px; font-size: 16px;">Change Password (Optional)</h4>
                    <div class="form-group">
                        <label class="form-label" for="currentPassword">Current Password</label>
                        <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password to change">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newPassword">New Password</label>
                        <input type="password" class="form-input" id="newPassword" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                        <input type="password" class="form-input" id="confirmNewPassword" placeholder="Confirm new password">
                    </div>
                </div>
                
                <button class="btn btn-primary btn-block" id="updateProfileBtn">
                    <i class="fas fa-save"></i>
                    Update Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2 class="modal-title">Privacy Policy</h2>
                <p class="modal-subtitle">Your privacy is our priority</p>
                <button class="modal-close" id="closePrivacyModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="policy-section">
                    <h3>Information We Collect</h3>
                    <p>DRUGBOT is designed to prioritize your privacy. We collect the minimal amount of information
                        necessary to provide, secure, and improve your AI medical assistance experience.</p>
                    <ul class="policy-list">
                        <li>Chat content and conversation history</li>
                        <li>Account information (if you create an account)</li>
                        <li>Technical data for security and performance</li>
                        <li>Usage data to improve our services</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h3>How We Use Your Information</h3>
                    <p>We use the information we collect to provide, maintain, and improve our services:</p>
                    <ul class="policy-list">
                        <li>To provide personalized medical assistance</li>
                        <li>To improve AI algorithms and response accuracy</li>
                        <li>To ensure platform security and prevent abuse</li>
                        <li>To communicate important updates and information</li>
                        <li>To comply with legal obligations</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h3>Data Security</h3>
                    <p>We implement industry-standard security measures to protect your personal information. All data
                        is encrypted in transit and at rest. Your medical conversations are treated with strict
                        confidentiality.</p>
                </div>

                <div class="policy-section">
                    <h3>Your Rights</h3>
                    <p>You have the right to access, correct, or delete your personal information. You can manage your
                        data through your account settings or by contacting us directly.</p>
                </div>

                <div class="policy-section">
                    <h3>Data Retention</h3>
                    <p>We retain your chat history for as long as your account is active. You can delete individual
                        chats or your entire account at any time through the settings menu.</p>
                </div>

                <div class="policy-section">
                    <h3>Third-Party Services</h3>
                    <p>We use trusted third-party services for AI processing and email delivery. These services are
                        contractually bound to protect your data and only process it for the purposes we specify.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Us Modal -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-headset"></i>
                </div>
                <h2 class="modal-title">Contact Us</h2>
                <p class="modal-subtitle">We're here to help you 24/7</p>
                <button class="modal-close" id="closeContactModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: var(--text-light); margin-bottom: 25px;">
                    Have questions or need support? Reach out to our team through any of the following channels:
                </p>

                <div class="contact-info">
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Primary Contact</h4>
                            <p>+233 257 477 888</p>
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Secondary Contact</h4>
                            <p>+233 534 111 407</p>
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Email Support</h4>
                            <p>yeboahcollins754@gmail.com</p>
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Technical Support</h4>
                            <p>annorprince64@gmail.com</p>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px;">
                    <h4 style="color: var(--text-color); margin-bottom: 10px; font-size: 16px;">Response Time</h4>
                    <p style="color: var(--text-light); font-size: 14px; line-height: 1.6;">
                        <i class="fas fa-clock" style="margin-right: 8px;"></i>
                        We typically respond to all inquiries within 24 hours. For emergency medical issues, please
                        contact local healthcare providers immediately.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- About Us Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h2 class="modal-title">About DRUGBOT</h2>
                <p class="modal-subtitle">Your AI Medical Companion</p>
                <button class="modal-close" id="closeAboutModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="policy-section">
                    <h3>Our Mission</h3>
                    <p>DRUGBOT is an advanced AI-powered medical assistant designed to make healthcare information
                        accessible, understandable, and actionable for everyone. Our mission is to bridge the gap
                        between medical knowledge and everyday health decisions.</p>
                </div>

                <div class="policy-section">
                    <h3>Key Features</h3>
                    <ul class="policy-list">
                        <li>Multilingual support (Twi and English)</li>
                        <li>Voice recognition for hands-free operation</li>
                        <li>Medical information and drug recommendations</li>
                        <li>Secure and private conversations</li>
                        <li>24/7 availability for health queries</li>
                        <li>Translation services for medical terms</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h3>Important Disclaimer</h3>
                    <p>DRUGBOT is an AI assistant designed to provide medical information and suggestions. It is not a
                        substitute for professional medical advice, diagnosis, or treatment. Always consult with
                        qualified healthcare providers for medical concerns.</p>
                </div>

                <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; border-left: 4px solid #667eea;">
                    <h4 style="color: var(--text-color); margin-bottom: 10px;">Developed With Passion</h4>
                    <p style="color: var(--text-light);">
                        By Annor Prince and Collins Yeboah<br>
                        <span style="font-size: 13px;">Dedicated to improving healthcare accessibility</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div class="modal" id="verificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-mail-bulk"></i>
                </div>
                <h2 class="modal-title">Verify Your Email</h2>
                <p class="modal-subtitle">Check your inbox for the verification code</p>
                <button class="modal-close" id="closeVerificationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 30px;">
                    <p style="color: var(--text-light); margin-bottom: 20px;">
                        We've sent a 6-digit verification code to your email address. Please enter it below to complete
                        your registration.
                    </p>

                    <input type="text" id="verificationCodeInput" class="form-input" placeholder="Enter 6-digit code"
                        maxlength="6" style="text-align: center; font-size: 24px; letter-spacing: 10px; padding: 15px; width: 200px;">
                </div>

                <div id="verificationError"
                    style="display: none; text-align: center; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid #ef4444; margin: 15px 0;">
                    <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                    Invalid verification code. Please try again.
                </div>

                <div id="verificationSuccess"
                    style="display: none; text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border-left: 4px solid #10b981; margin: 15px 0;">
                    <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                    Email verified successfully! Welcome to DRUGBOT.
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        (function () {
            emailjs.init("lTUvDRylLKuYhqt9o");
        })();
    </script>

   <script>
    // Backend API Configuration
    const BACKEND_URL = 'https://med-ai-48yi.onrender.com/api/analyze';
    const AUTH_URL = 'https://med-ai-48yi.onrender.com/api';

    // DOM Elements for new input system
    const chatTextarea = document.getElementById('chatTextarea');
    const sendBtn = document.getElementById('sendBtn');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const profileModal = document.getElementById('profileModal');
    const closeProfileModal = document.getElementById('closeProfileModal');
    const updateProfileBtn = document.getElementById('updateProfileBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatContainer = document.getElementById('chatContainer');
    const chatHistory = document.getElementById('chatHistory');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const statusIndicator = document.getElementById('statusIndicator');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const userProfile = document.getElementById('userProfile');
    const userName = document.getElementById('userName');
    const loginModal = document.getElementById('loginModal');
    const registerModal = document.getElementById('registerModal');
    const privacyModal = document.getElementById('privacyModal');
    const contactModal = document.getElementById('contactModal');
    const aboutModal = document.getElementById('aboutModal');
    const verificationModal = document.getElementById('verificationModal');

    // Application State
    let currentUser = null;
    let currentChatId = generateChatId();
    let chatHistoryData = {};
    let isListening = false;
    let recognition;
    let audioEnabled = false;
    let verificationCode = '';
    let pendingUser = null;

    // Initialize speech recognition
    function initializeSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function () {
                isListening = true;
                voiceInputBtn.classList.add('listening');
                statusIndicator.textContent = "Listening... Speak now";
                chatTextarea.disabled = true;
            };

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript.trim();
                if (transcript) {
                    chatTextarea.value = transcript;
                    statusIndicator.textContent = `Heard: "${transcript}"`;
                    autoResizeTextarea();
                }
            };

            recognition.onerror = function (event) {
                console.error('Speech recognition error', event.error);
                let errorMsg = `Error: ${event.error}`;
                statusIndicator.textContent = errorMsg;
                resetListeningState();
            };

            recognition.onend = function () {
                resetListeningState();
            };
        } else {
            statusIndicator.textContent = "Speech recognition not supported in this browser";
        }
    }

    function resetListeningState() {
        isListening = false;
        voiceInputBtn.classList.remove('listening');
        chatTextarea.disabled = false;
        if (statusIndicator.textContent.startsWith("Listening")) {
            statusIndicator.textContent = "Ready to chat - Type or speak your message";
        }
    }

    function toggleListening() {
        if (!recognition) {
            alert('Speech recognition not supported in your browser');
            return;
        }

        if (isListening) {
            recognition.stop();
            resetListeningState();
        } else {
            try {
                recognition.lang = 'en-US';
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                statusIndicator.textContent = "Error starting voice recognition";
            }
        }
    }

    // Textarea auto-resize
    function autoResizeTextarea() {
        chatTextarea.style.height = 'auto';
        const newHeight = Math.min(chatTextarea.scrollHeight, 200);
        chatTextarea.style.height = newHeight + 'px';
        
        // Show/hide scrollbar based on content
        if (chatTextarea.scrollHeight > 200) {
            chatTextarea.style.overflowY = 'scroll';
        } else {
            chatTextarea.style.overflowY = 'hidden';
        }
    }

    // Send message function
    function sendMessage() {
        const text = chatTextarea.value.trim();
        if (text) {
            processUserInput(text);
            chatTextarea.value = '';
            autoResizeTextarea();
            sendBtn.disabled = true;
        }
    }

    // Initialize the app
    function initializeApp() {
        // Load audio preference
        const savedAudio = localStorage.getItem('medAI_audioEnabled');
        if (savedAudio !== null) {
            audioEnabled = savedAudio === 'true';
            const btn = document.getElementById('audioToggleBtn');
            const icon = document.getElementById('audioToggleIcon');
            if (!audioEnabled) {
                btn.classList.add('audio-disabled');
                icon.className = 'fas fa-volume-mute';
            }
        }

        // Initialize speech recognition
        initializeSpeechRecognition();

        // Check if user is already logged in
        const savedUser = localStorage.getItem('medAI_currentUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                updateUserDisplay();
                loadUserChatHistory(currentUser.id);
            } catch (e) {
                console.error('Error loading user:', e);
                loadGuestData();
            }
        } else {
            loadGuestData();
        }

        // Setup event listeners for new input system
        setupEventListeners();
        startPeriodicSync();
    }

    function setupEventListeners() {
        // Textarea input events
        chatTextarea.addEventListener('input', function() {
            autoResizeTextarea();
            sendBtn.disabled = !this.value.trim();
        });

        chatTextarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.value.trim()) {
                    sendMessage();
                }
            }
        });

        // Send button
        sendBtn.addEventListener('click', sendMessage);

        // Voice button
        voiceInputBtn.addEventListener('click', toggleListening);

        // Suggestion buttons
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const prompt = this.getAttribute('data-prompt');
                chatTextarea.value = prompt;
                autoResizeTextarea();
                sendBtn.disabled = false;
                chatTextarea.focus();
            });
        });

        // Profile modal close button
        closeProfileModal.addEventListener('click', function() {
            profileModal.style.display = 'none';
            clearProfileMessages();
        });

        // Profile update button
        updateProfileBtn.addEventListener('click', updateUserProfile);
    }

    // Profile update function
    async function updateUserProfile() {
        const name = document.getElementById('profileName').value.trim();
        const email = document.getElementById('profileEmail').value.trim();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        const errorDiv = document.getElementById('profileError');
        const successDiv = document.getElementById('profileSuccess');

        // Clear previous messages
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        // Validation
        if (!name) {
            showProfileError('Name is required');
            return;
        }

        if (!email) {
            showProfileError('Email is required');
            return;
        }

        // If password change is attempted
        if (newPassword || confirmNewPassword) {
            if (!currentPassword) {
                showProfileError('Current password is required to change password');
                return;
            }

            if (newPassword.length < 6) {
                showProfileError('New password must be at least 6 characters');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showProfileError('New passwords do not match');
                return;
            }
        }

        try {
            updateProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            updateProfileBtn.disabled = true;

            const response = await fetch(`${AUTH_URL}/update-profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    originalEmail: currentUser.email,
                    name: name,
                    newEmail: email,
                    currentPassword: currentPassword || null,
                    newPassword: newPassword || null
                })
            });

            const result = await response.json();

            if (result.success) {
                // Update current user
                currentUser = result.user;
                localStorage.setItem('medAI_currentUser', JSON.stringify(currentUser));
                updateUserDisplay();

                // Show success
                showProfileSuccess('Profile updated successfully!');

                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';

                // Update button state
                updateProfileBtn.innerHTML = '<i class="fas fa-save"></i> Update Profile';
                updateProfileBtn.disabled = false;

            } else {
                throw new Error(result.error || 'Update failed');
            }
        } catch (error) {
            showProfileError(error.message);
            updateProfileBtn.innerHTML = '<i class="fas fa-save"></i> Update Profile';
            updateProfileBtn.disabled = false;
        }
    }

    function showProfileError(message) {
        const errorDiv = document.getElementById('profileError');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function showProfileSuccess(message) {
        const successDiv = document.getElementById('profileSuccess');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
    }

    function clearProfileMessages() {
        document.getElementById('profileError').style.display = 'none';
        document.getElementById('profileSuccess').style.display = 'none';
    }

    // Utility functions
    function generateChatId() {
        return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function updateUserDisplay() {
        if (!currentUser) {
            userName.textContent = 'Guest User';
            return;
        }

        const nameProperty = currentUser.name || currentUser.username || currentUser.fullName || 'User';
        const nameParts = nameProperty.toString().trim().split(' ');
        const surname = nameParts[nameParts.length - 1];
        userName.textContent = surname || 'User';

        // Update profile modal with current user data
        if (document.getElementById('profileName')) {
            document.getElementById('profileName').value = nameProperty;
            document.getElementById('profileEmail').value = currentUser.email || '';
        }
    }

    // Toggle audio responses
    function toggleAudioResponses() {
        audioEnabled = !audioEnabled;
        const btn = document.getElementById('audioToggleBtn');
        const icon = document.getElementById('audioToggleIcon');

        if (audioEnabled) {
            btn.classList.remove('audio-disabled');
            icon.className = 'fas fa-volume-up';
            statusIndicator.textContent = 'Audio responses enabled';
        } else {
            btn.classList.add('audio-disabled');
            icon.className = 'fas fa-volume-mute';
            statusIndicator.textContent = 'Audio responses disabled';
        }

        localStorage.setItem('medAI_audioEnabled', audioEnabled);
        setTimeout(() => {
            statusIndicator.textContent = 'Ready to chat';
        }, 2000);
    }

    // Email verification functions
    async function sendVerificationEmail(email, code) {
        return new Promise((resolve) => {
            emailjs.send('service_zjhyid5', 'template_vha29yp', {
                to_email: email,
                verification_code: code,
            }).then(
                function (response) {
                    console.log('[EMAIL] Email sent successfully');
                    resolve(true);
                },
                function (error) {
                    console.error('[EMAIL] Failed to send email:', error);
                    alert('Failed to send verification email. Please check your email address and try again.');
                    resolve(false);
                }
            );
        });
    }

    function generateVerificationCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    function setupAutoVerify() {
        const input = document.getElementById('verificationCodeInput');
        const errorDiv = document.getElementById('verificationError');
        const successDiv = document.getElementById('verificationSuccess');

        if (!input) return;

        input.addEventListener('input', function (e) {
            this.value = this.value.replace(/[^0-9]/g, '');

            if (this.value.length === 6) {
                const enteredCode = this.value;

                if (enteredCode === verificationCode) {
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'block';
                    input.disabled = true;
                    input.style.borderColor = 'var(--primary-color)';

                    setTimeout(() => {
                        completeRegistration();
                    }, 1000);
                } else {
                    successDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    input.value = '';
                    input.focus();
                }
            }
        });
    }

    async function loginUser(email, password) {
        const loginBtn = document.querySelector('#loginForm .btn-primary');
        const originalText = loginBtn.textContent;

        try {
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            loginBtn.disabled = true;

            const response = await fetch(`${AUTH_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, password: password })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                currentUser = result.user;
                localStorage.setItem('medAI_currentUser', JSON.stringify(currentUser));
                updateUserDisplay();
                
                await checkCloudSyncStatus();
                await loadUserChatHistory(currentUser.id);

                loginBtn.innerHTML = '<i class="fas fa-check"></i> Success!';
                loginBtn.style.backgroundColor = '#10a37f';

                setTimeout(() => {
                    loginModal.style.display = 'none';
                    statusIndicator.textContent = `Welcome back, ${userName.textContent}!`;
                    loginBtn.textContent = originalText;
                    loginBtn.disabled = false;
                    loginBtn.style.backgroundColor = '';
                    document.getElementById('loginForm').reset();
                }, 1000);

            } else {
                throw new Error(result.error || "Invalid email or password");
            }
        } catch (error) {
            loginBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
            loginBtn.style.backgroundColor = '#ef4444';

            setTimeout(() => {
                alert(error.message || "Login failed. Please check your connection and try again.");
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
                loginBtn.style.backgroundColor = '';
            }, 1000);
        }
    }

 async function registerUser(name, email, password) {
    const registerBtn = document.querySelector('#registerForm .btn-primary');
    const originalText = registerBtn.textContent;

    try {
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
        registerBtn.disabled = true;

        // First, check if email is already registered
        try {
            const checkResponse = await fetch(`${AUTH_URL}/debug/database`);
            console.log('Database debug:', await checkResponse.json());
        } catch (e) {
            console.log('Debug endpoint not available');
        }

        verificationCode = generateVerificationCode();
        console.log(`Generated verification code: ${verificationCode}`);
        
        const emailSent = await sendVerificationEmail(email, verificationCode);

        if (!emailSent) {
            throw new Error('Failed to send verification email. Please check your email address.');
        }

        pendingUser = { name, email, password };
        registerModal.style.display = 'none';
        verificationModal.style.display = 'flex';

        const input = document.getElementById('verificationCodeInput');
        const errorDiv = document.getElementById('verificationError');
        const successDiv = document.getElementById('verificationSuccess');

        input.value = '';
        input.disabled = false;
        input.style.borderColor = '';
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        input.focus();

        registerBtn.textContent = originalText;
        registerBtn.disabled = false;

    } catch (error) {
        registerBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
        registerBtn.style.backgroundColor = '#ef4444';

        setTimeout(() => {
            alert(error.message || 'Registration failed. Please try again.');
            registerBtn.textContent = originalText;
            registerBtn.disabled = false;
            registerBtn.style.backgroundColor = '';
        }, 1000);
    }
}

    async function completeRegistration() {
        if (!pendingUser) return;

        try {
            const response = await fetch(`${AUTH_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: pendingUser.name,
                    email: pendingUser.email,
                    password: pendingUser.password
                })
            });

            const result = await response.json();

            if (result.success) {
                currentUser = result.user;
                localStorage.setItem('medAI_currentUser', JSON.stringify(currentUser));
                updateUserDisplay();
                loadUserChatHistory(currentUser.id);

                verificationModal.style.display = 'none';
                statusIndicator.textContent = `Welcome to DRUGBOT, ${userName.textContent}!`;
                document.getElementById('registerForm').reset();
                pendingUser = null;
                verificationCode = '';
                
                // Auto-login successful
                setTimeout(() => {
                    statusIndicator.textContent = `Welcome to DRUGBOT, ${userName.textContent}!`;
                }, 1000);
                
            } else {
                throw new Error(result.error || 'Registration failed after verification.');
            }
        } catch (error) {
            alert('Registration failed after verification. Please try again.');
            verificationModal.style.display = 'none';
            registerModal.style.display = 'flex';
            
            // Reset verification state
            const input = document.getElementById('verificationCodeInput');
            const errorDiv = document.getElementById('verificationError');
            const successDiv = document.getElementById('verificationSuccess');
            
            if (input) input.value = '';
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';
        }
    }

   async function loadUserChatHistory(userId) {
    if (!userId) {
        loadGuestData();
        return;
    }

    console.log(`[LOAD] Loading chat history for user: ${userId}`);
    
    // Start with empty data
    chatHistoryData = {};

    try {
        // Try to load from cloud first
        console.log('[LOAD] Attempting to load from cloud...');
        const response = await fetch(`${AUTH_URL}/chats/load?user_id=${userId}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[LOAD] Cloud response:', result);
            
            if (result.success && result.chats) {
                console.log(`[LOAD] Found ${Object.keys(result.chats).length} chats in cloud`);
                
                // Validate and use cloud data
                chatHistoryData = validateChatData(result.chats);
                console.log(`[LOAD] Validated ${Object.keys(chatHistoryData).length} chats from cloud`);
                
                // Save cloud data to local storage
                const userHistoryKey = `medAI_chatHistory_${userId}`;
                localStorage.setItem(userHistoryKey, JSON.stringify(chatHistoryData));
                console.log('[LOAD] Saved cloud data to local storage');
                
            } else {
                console.log('[LOAD] No cloud data or error:', result.error);
                loadFromLocalStorage(userId);
            }
        } else {
            console.log('[LOAD] Cloud load failed, status:', response.status);
            loadFromLocalStorage(userId);
        }
    } catch (error) {
        console.error('[LOAD] Error loading from cloud:', error);
        loadFromLocalStorage(userId);
    }

    // If still no data, create initial chat
    if (Object.keys(chatHistoryData).length === 0) {
        console.log('[LOAD] No chat data found, creating initial chat');
        createInitialChat();
    }

    // Set current chat to most recent
    const chatIds = Object.keys(chatHistoryData);
    if (chatIds.length > 0) {
        const sortedChats = chatIds.sort((a, b) => {
            const dateA = chatHistoryData[a].date ? new Date(chatHistoryData[a].date) : new Date(0);
            const dateB = chatHistoryData[b].date ? new Date(chatHistoryData[b].date) : new Date(0);
            return dateB - dateA;
        });
        currentChatId = sortedChats[0];
        console.log(`[LOAD] Set current chat to: ${currentChatId}`);
    }

    renderChatHistory();
    loadChat(currentChatId);
    
    console.log(`[LOAD] Final chat count: ${Object.keys(chatHistoryData).length}`);
}

function loadFromLocalStorage(userId) {
    console.log(`[LOAD] Loading from local storage for user: ${userId}`);
    const userHistoryKey = `medAI_chatHistory_${userId}`;
    const savedHistory = localStorage.getItem(userHistoryKey);
    
    if (savedHistory) {
        try {
            chatHistoryData = JSON.parse(savedHistory);
            console.log(`[LOAD] Loaded ${Object.keys(chatHistoryData).length} chats from local storage`);
        } catch (e) {
            console.error('[LOAD] Error parsing local storage:', e);
            chatHistoryData = {};
        }
    } else {
        console.log('[LOAD] No local storage data found');
        chatHistoryData = {};
    }
}
    function validateChatData(chatData) {
        const validated = {};
        Object.keys(chatData).forEach(chatId => {
            const chat = chatData[chatId];
            validated[chatId] = {
                id: chatId,
                title: chat.title || "Untitled Conversation",
                date: chat.date || new Date().toISOString(),
                messages: []
            };

            if (Array.isArray(chat.messages)) {
                chat.messages.forEach(msg => {
                    const validatedMsg = {
                        role: msg.role === 'user' ? 'user' : 'ai',
                        content: msg.content || '',
                        timestamp: msg.timestamp || new Date().toISOString()
                    };

                    if (msg.isMedical !== undefined) validatedMsg.isMedical = Boolean(msg.isMedical);
                    if (msg.drugRecommendation) validatedMsg.drugRecommendation = msg.drugRecommendation;
                    if (msg.disclaimer) validatedMsg.disclaimer = msg.disclaimer;

                    validated[chatId].messages.push(validatedMsg);
                });
            }
        });
        return validated;
    }

    function loadFromLocalStorage(userId) {
        const userHistoryKey = `medAI_chatHistory_${userId}`;
        const savedHistory = localStorage.getItem(userHistoryKey);
        if (savedHistory) {
            try {
                chatHistoryData = JSON.parse(savedHistory);
            } catch (e) {
                chatHistoryData = {};
            }
        } else {
            chatHistoryData = {};
        }
    }

    function loadGuestData() {
        const savedHistory = localStorage.getItem('medAI_guestHistory');
        if (savedHistory) {
            chatHistoryData = JSON.parse(savedHistory);
        } else {
            chatHistoryData = {
                [currentChatId]: {
                    id: currentChatId,
                    title: "DRUGBOT Assistant",
                    date: new Date().toISOString(),
                    messages: [{
                        role: "ai",
                        content: "Hello! I'm your AI medical assistant. I can understand Twi and English speech. I can help with medical questions, general knowledge, translations, and more. Select your language and either type your message or use the voice button to speak to me.",
                        timestamp: new Date().toISOString()
                    }]
                }
            };
            saveChatHistory();
        }
        renderChatHistory();
        loadChat(currentChatId);
    }

    function createInitialChat() {
        currentChatId = generateChatId();
        chatHistoryData = {
            [currentChatId]: {
                id: currentChatId,
                title: "Welcome to DRUGBOT",
                date: new Date().toISOString(),
                messages: [{
                    role: "ai",
                    content: "Hello! I'm your AI medical assistant. How can I help you today?",
                    timestamp: new Date().toISOString()
                }]
            }
        };
    }

 async function saveChatHistory() {
    console.log('[SAVE] Starting save process...');
    console.log('[SAVE] Current user:', currentUser ? currentUser.id : 'none');
    console.log('[SAVE] Chat count:', Object.keys(chatHistoryData).length);
    
    if (currentUser) {
        const userHistoryKey = `medAI_chatHistory_${currentUser.id}`;
        
        // Log what we're saving
        Object.keys(chatHistoryData).forEach(chatId => {
            const chat = chatHistoryData[chatId];
            console.log(`[SAVE] Chat ${chatId}: "${chat.title}" with ${chat.messages ? chat.messages.length : 0} messages`);
        });
        
        localStorage.setItem(userHistoryKey, JSON.stringify(chatHistoryData));
        console.log('[SAVE] âœ… Saved to local storage');
        
        document.getElementById('statusIndicator').textContent = 'Saved locally âœ“';
        renderChatHistory();
        
        // Attempt cloud sync
        await attemptCloudSync();
    } else {
        localStorage.setItem('medAI_guestHistory', JSON.stringify(chatHistoryData));
        console.log('[SAVE] âœ… Saved to guest storage');
        renderChatHistory();
    }
}
    async function attemptCloudSync() {
        if (!currentUser) return;
        
        console.log('[CLOUD] Attempting cloud sync...');
        
        try {
            // Send all chats, not just current
            const syncPayload = {
                user_id: currentUser.id,
                chat_data: chatHistoryData
            };
            
            console.log('[CLOUD] Sending payload with', Object.keys(chatHistoryData).length, 'chats');
            
            const response = await fetch(`${AUTH_URL}/chats/save`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(syncPayload)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                console.log('[CLOUD] Sync successful');
                const indicator = document.getElementById('statusIndicator');
                indicator.textContent = 'âœ“ Synced to cloud';
                
                // Store last sync timestamp
                localStorage.setItem(`medAI_lastSync_${currentUser.id}`, new Date().toISOString());
                
                setTimeout(() => {
                    indicator.textContent = 'Ready to chat';
                }, 3000);
            } else {
                console.error('[CLOUD] Server error:', result.error);
                document.getElementById('statusIndicator').textContent = 'Sync failed - using local storage';
            }
            
        } catch (error) {
            console.error('[CLOUD] Network error:', error.message);
            document.getElementById('statusIndicator').textContent = 'Offline mode - using local storage';
        }
    }

    function startPeriodicSync() {
        setInterval(() => {
            if (currentUser && Object.keys(chatHistoryData).length > 0) {
                saveChatHistory();
            }
        }, 30000);
    }
async function debugCloudData(userId) {
    console.log('=== DEBUG CLOUD DATA ===');
    
    try {
        const response = await fetch(`${AUTH_URL}/chats/load?user_id=${userId}`);
        console.log('Response status:', response.status);
        
        const result = await response.json();
        console.log('Response data:', result);
        
        if (result.success && result.chats) {
            console.log(`Found ${Object.keys(result.chats).length} chats:`);
            Object.keys(result.chats).forEach(chatId => {
                const chat = result.chats[chatId];
                console.log(`  Chat: ${chatId}`);
                console.log(`    Title: ${chat.title}`);
                console.log(`    Messages: ${Array.isArray(chat.messages) ? chat.messages.length : 'Invalid'}`);
                console.log(`    Date: ${chat.date}`);
            });
        } else {
            console.log('No chats or error:', result.error);
        }
    } catch (error) {
        console.error('Debug error:', error);
    }
}

// Add a debug button to your UI temporarily
function addDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = 'Debug Cloud';
    debugBtn.style.position = 'fixed';
    debugBtn.style.bottom = '60px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '1000';
    debugBtn.style.padding = '10px';
    debugBtn.style.background = '#f59e0b';
    debugBtn.style.color = 'white';
    debugBtn.style.border = 'none';
    debugBtn.style.borderRadius = '5px';
    debugBtn.style.cursor = 'pointer';
    debugBtn.onclick = () => {
        if (currentUser) {
            debugCloudData(currentUser.id);
        } else {
            alert('Please login first');
        }
    };
    document.body.appendChild(debugBtn);
}

// Call this in your initializeApp function
// addDebugButton();
    async function checkCloudSyncStatus() {
        if (!currentUser) return;
        
        try {
            const response = await fetch(`${AUTH_URL}/chats/status?user_id=${currentUser.id}`);
            if (response.ok) {
                const result = await response.json();
                if (result.lastSync) {
                    const localSync = localStorage.getItem(`medAI_lastSync_${currentUser.id}`);
                    if (!localSync || new Date(localSync) < new Date(result.lastSync)) {
                        console.log('[SYNC] Cloud has newer data, triggering load...');
                        loadUserChatHistory(currentUser.id);
                    }
                }
            }
        } catch (error) {
            console.log('[SYNC] Cloud status check failed, using local data.');
        }
    }

    function renderChatHistory() {
        chatHistory.innerHTML = '';
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();

        const todayChats = [];
        const yesterdayChats = [];
        const olderChats = [];

        Object.values(chatHistoryData).forEach(chat => {
            const chatDate = new Date(chat.date).toDateString();
            if (chatDate === today) todayChats.push(chat);
            else if (chatDate === yesterday) yesterdayChats.push(chat);
            else olderChats.push(chat);
        });

        if (todayChats.length > 0) {
            const todayTitle = document.createElement('div');
            todayTitle.className = 'history-title';
            todayTitle.textContent = 'Today';
            chatHistory.appendChild(todayTitle);
            todayChats.forEach(chat => chatHistory.appendChild(createHistoryItem(chat)));
        }

        if (yesterdayChats.length > 0) {
            const yesterdayTitle = document.createElement('div');
            yesterdayTitle.className = 'history-title';
            yesterdayTitle.textContent = 'Yesterday';
            chatHistory.appendChild(yesterdayTitle);
            yesterdayChats.forEach(chat => chatHistory.appendChild(createHistoryItem(chat)));
        }

        if (olderChats.length > 0) {
            const olderTitle = document.createElement('div');
            olderTitle.className = 'history-title';
            olderTitle.textContent = 'Previous 7 Days';
            chatHistory.appendChild(olderTitle);
            olderChats.forEach(chat => chatHistory.appendChild(createHistoryItem(chat)));
        }
    }

    function createHistoryItem(chat) {
        const historyItem = document.createElement('div');
        historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
        historyItem.dataset.chatId = chat.id;

        const itemContent = document.createElement('div');
        itemContent.className = 'history-item-content';

        const icon = document.createElement('i');
        icon.className = 'fas fa-message';

        const title = document.createElement('span');
        title.className = 'history-item-title';
        title.textContent = chat.title;

        itemContent.appendChild(icon);
        itemContent.appendChild(title);
        historyItem.appendChild(itemContent);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-btn';
        deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
        deleteBtn.style.opacity = '0.5';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteChat(chat.id);
        };
        historyItem.appendChild(deleteBtn);

        historyItem.addEventListener('click', () => loadChat(chat.id));
        return historyItem;
    }

    function loadChat(chatId) {
        document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
        const activeItem = document.querySelector(`.history-item[data-chat-id="${chatId}"]`);
        if (activeItem) activeItem.classList.add('active');

        currentChatId = chatId;
        chatContainer.innerHTML = '';

        const chat = chatHistoryData[chatId];
        if (chat && chat.messages) {
            chat.messages.forEach((message) => {
                try {
                    addMessageToChat(
                        message.content || '',
                        message.role === 'user',
                        false,
                        false,
                        message.isMedical || false,
                        message.drugRecommendation || null,
                        message.disclaimer || null,
                        false
                    );
                } catch (error) {
                    addMessageToChat(
                        `Error loading message: ${error.message}`,
                        false,
                        false,
                        true,
                        false,
                        null,
                        null,
                        false
                    );
                }
            });
        } else {
            addMessageToChat(
                "Hello! I'm your AI medical assistant. How can I help you today?",
                false,
                false,
                false,
                false,
                null,
                null,
                false
            );
        }

        if (window.innerWidth <= 768) sidebar.classList.remove('open');
        setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 100);
    }

    function deleteChat(chatId) {
        if (Object.keys(chatHistoryData).length === 1) {
            alert('You cannot delete your only chat.');
            return;
        }

        if (confirm('Are you sure you want to delete this chat?')) {
            delete chatHistoryData[chatId];
            saveChatHistory();
            renderChatHistory();

            if (chatId === currentChatId) {
                const remainingChatIds = Object.keys(chatHistoryData);
                if (remainingChatIds.length > 0) loadChat(remainingChatIds[0]);
            }
        }
    }

    function createNewChat() {
        currentChatId = generateChatId();
        chatHistoryData[currentChatId] = {
            id: currentChatId,
            title: "New Conversation",
            date: new Date().toISOString(),
            messages: [{
                role: "ai",
                content: "Hello! I'm your AI medical assistant. How can I help you today?",
                timestamp: new Date().toISOString()
            }]
        };

        saveChatHistory();
        renderChatHistory();
        loadChat(currentChatId);
        statusIndicator.textContent = "New chat created";
    }

    function renderMarkdown(text) {
        if (!text) return '';
        
        const lines = text.split('\n');
        let result = [];
        let tableRows = [];
        let inTable = false;
        
        for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
            const line = lines[lineIndex];
            const trimmedLine = line.trim();
            
            // Handle tables
            if (trimmedLine.includes('|') && !inTable) {
                inTable = true;
                tableRows = [line];
                continue;
            }
            
            if (inTable) {
                if (trimmedLine.includes('|')) {
                    tableRows.push(line);
                } else {
                    processTable();
                    inTable = false;
                    lineIndex--;
                }
                continue;
            }
            
            processRegularLine(line, trimmedLine, lineIndex);
        }
        
        if (inTable && tableRows.length > 0) {
            processTable();
        }
        
        return result.join('');
        
        function processTable() {
            if (tableRows.length < 2) {
                result.push(tableRows.join('<br>') + '<br>');
                tableRows = [];
                return;
            }
            
            let tableHtml = '<table class="ai-table"><tbody>';
            let hasHeaderSeparator = tableRows.length > 1 && /^[\s\|:-]+$/.test(tableRows[1].trim());
            
            for (let rowIndex = 0; rowIndex < tableRows.length; rowIndex++) {
                const row = tableRows[rowIndex];
                
                if (/^[\s\|:-]+$/.test(row.trim())) {
                    continue;
                }
                
                const cells = row.split('|')
                    .map(cell => cell.trim())
                    .filter(cell => cell !== '');
                
                if (cells.length === 0) continue;
                
                tableHtml += '<tr>';
                
                for (let cellIndex = 0; cellIndex < cells.length; cellIndex++) {
                    let cellContent = cells[cellIndex];
                    
                    cellContent = cellContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    cellContent = cellContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
                    
                    if ((rowIndex === 0 && !hasHeaderSeparator) || 
                        (rowIndex === 1 && hasHeaderSeparator)) {
                        tableHtml += `<th>${cellContent}</th>`;
                    } else {
                        tableHtml += `<td>${cellContent}</td>`;
                    }
                }
                
                tableHtml += '</tr>';
            }
            
            tableHtml += '</tbody></table>';
            result.push(tableHtml);
            tableRows = [];
        }
        
        function processRegularLine(line, trimmedLine, currentLineIndex) {
            let processedLine = line;
            
            if (trimmedLine.startsWith('### ')) {
                result.push(`<h3>${trimmedLine.substring(4)}</h3>`);
                return;
            }
            
            if (trimmedLine.startsWith('## ')) {
                result.push(`<h2>${trimmedLine.substring(3)}</h2>`);
                return;
            }
            
            if (trimmedLine.match(/^[-*]\s+/)) {
                let listHtml = '<ul>';
                while (currentLineIndex < lines.length && lines[currentLineIndex].trim().match(/^[-*]\s+/)) {
                    let item = lines[currentLineIndex].trim().substring(2).trim();
                    item = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    item = item.replace(/\*(.*?)\*/g, '<em>$1</em>');
                    listHtml += `<li>${item}</li>`;
                    currentLineIndex++;
                }
                listHtml += '</ul>';
                result.push(listHtml);
                lineIndex = currentLineIndex - 1;
                return;
            }
            
            if (trimmedLine.match(/^\d+\.\s+/)) {
                let listHtml = '<ol>';
                while (currentLineIndex < lines.length && lines[currentLineIndex].trim().match(/^\d+\.\s+/)) {
                    let item = lines[currentLineIndex].trim().replace(/^\d+\.\s+/, '').trim();
                    item = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    item = item.replace(/\*(.*?)\*/g, '<em>$1</em>');
                    listHtml += `<li>${item}</li>`;
                    currentLineIndex++;
                }
                listHtml += '</ol>';
                result.push(listHtml);
                lineIndex = currentLineIndex - 1;
                return;
            }
            
            if (trimmedLine.length > 0) {
                processedLine = processedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                processedLine = processedLine.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                if (result.length > 0 && !result[result.length - 1].endsWith('</p>')) {
                    const lastIndex = result.length - 1;
                    result[lastIndex] = result[lastIndex].replace(/<\/p>$/, '');
                    result[lastIndex] += `<br>${processedLine}</p>`;
                } else {
                    result.push(`<p>${processedLine}</p>`);
                }
            } else {
                if (result.length > 0) {
                    result.push('<br>');
                }
            }
        }
    }

    function addMessageToChat(content, isUser = false, isTyping = false, isError = false, isMedical = false, drugRecommendation = null, disclaimer = null, saveToHistory = true) {
        if (!content && !isTyping) {
            content = "Message content unavailable";
            isError = true;
        }

        if (typeof content !== 'string') content = String(content || '');

        const messageDiv = document.createElement('div');
        let messageClass = `message ${isUser ? 'user-message' : 'ai-message'}`;
        if (isMedical) messageClass += ' medical-message';
        if (isError) messageClass += ' error-message';
        messageDiv.className = messageClass;

        const avatarDiv = document.createElement('div');
        avatarDiv.className = `message-avatar ${isUser ? 'user-avatar' : 'ai-avatar'}`;
        avatarDiv.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        if (isTyping) {
            contentDiv.innerHTML = 'Thinking<span class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>';
        } else {
            if (!isUser && !isError) {
                contentDiv.innerHTML = renderMarkdown(content);
            } else {
                contentDiv.innerHTML = `<p>${(content || '').toString().replace(/\n/g, '<br>')}</p>`;
            }

            if (drugRecommendation && drugRecommendation !== 'null' && drugRecommendation !== 'undefined') {
                try {
                    const drugDiv = document.createElement('div');
                    drugDiv.className = 'drug-recommendation';
                    drugDiv.innerHTML = `<strong>ðŸ’Š Recommended OTC Medication:</strong> ${renderMarkdown(drugRecommendation)}`;
                    contentDiv.appendChild(drugDiv);
                } catch (error) {
                    console.error('Error adding drug recommendation:', error);
                }
            }

            if (disclaimer && disclaimer !== 'null' && disclaimer !== 'undefined') {
                try {
                    const disclaimerDiv = document.createElement('div');
                    disclaimerDiv.className = 'disclaimer';
                    disclaimerDiv.innerHTML = `<strong>âš ï¸ Important:</strong> ${disclaimer}`;
                    contentDiv.appendChild(disclaimerDiv);
                } catch (error) {
                    console.error('Error adding disclaimer:', error);
                }
            }

            if (!isUser && !isError) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="action-btn" onclick="copyToClipboard(this)"><i class="fas fa-copy"></i></button>
                    <button class="action-btn"><i class="fas fa-thumbs-up"></i></button>
                    <button class="action-btn"><i class="fas fa-thumbs-down"></i></button>
                `;
                contentDiv.appendChild(actionsDiv);
            }
        }

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        if (saveToHistory && !isTyping && !isError) {
            if (!chatHistoryData[currentChatId]) {
                chatHistoryData[currentChatId] = {
                    id: currentChatId,
                    title: "New Conversation",
                    date: new Date().toISOString(),
                    messages: []
                };
            }

            const messageData = {
                role: isUser ? 'user' : 'ai',
                content: content || '',
                timestamp: new Date().toISOString()
            };

            if (isMedical !== undefined) messageData.isMedical = Boolean(isMedical);
            if (drugRecommendation) messageData.drugRecommendation = drugRecommendation;
            if (disclaimer) messageData.disclaimer = disclaimer;

            if (Array.isArray(chatHistoryData[currentChatId].messages)) {
                chatHistoryData[currentChatId].messages.push(messageData);
            } else {
                chatHistoryData[currentChatId].messages = [messageData];
            }

            if (isUser && (chatHistoryData[currentChatId].title === "New Conversation" ||
                chatHistoryData[currentChatId].title === "Welcome to DRUGBOT")) {
                const shortMessage = content.length > 30 ? content.substring(0, 30) + '...' : content;
                chatHistoryData[currentChatId].title = shortMessage;
            }

            chatHistoryData[currentChatId].date = new Date().toISOString();

            if (!isTyping) {
                setTimeout(() => saveChatHistory(), 100);
            }
        }

        return messageDiv;
    }

    // AI API call
    async function callBackendAPI(userMessage) {
        try {
            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: userMessage })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const responseText = await response.text();
            return JSON.parse(responseText);
        } catch (error) {
            console.error('API call failed:', error);
            throw error;
        }
    }

    async function processUserInput(input) {
        if (!input.trim()) return;

        addMessageToChat(input, true);
        statusIndicator.textContent = "Processing with AI...";
        const typingMessage = addMessageToChat("Analyzing your message...", false, true);

        try {
            const response = await callBackendAPI(input);
            typingMessage.remove();

            addMessageToChat(
                response.response,
                false,
                false,
                false,
                response.is_medical,
                response.drug_recommendation,
                response.disclaimer
            );

            if (response.translation && response.translation !== "Error processing request") {
                const translationDiv = document.createElement('div');
                translationDiv.style.marginTop = '10px';
                translationDiv.style.fontSize = '0.9rem';
                translationDiv.style.opacity = '0.8';
                translationDiv.style.fontStyle = 'italic';
                translationDiv.textContent = `ðŸ” Translation: "${response.translation}"`;
                chatContainer.lastChild.querySelector('.message-content').appendChild(translationDiv);
            }

            statusIndicator.textContent = "Response ready";
            speakResponse(response.response);
            setTimeout(() => saveChatHistory(), 500);

        } catch (error) {
            typingMessage.remove();
            const errorMessage = `I'm having trouble connecting to the server. Please check your internet connection and try again.\n\nError details: ${error.message}`;
            addMessageToChat(errorMessage, false, false, true);
            statusIndicator.textContent = "Connection error. Please try again.";
        }
    }

    function cleanTextForSpeech(text) {
        if (!text) return '';
        
        // Remove markdown headings
        let cleaned = text.replace(/#{1,6}\s+/g, '');
        
        // Remove bold/italic markers but keep the text
        cleaned = cleaned.replace(/\*\*/g, '');
        cleaned = cleaned.replace(/\*/g, '');
        
        // Remove code blocks
        cleaned = cleaned.replace(/`{1,3}[^`]*`{1,3}/g, '');
        
        // Remove markdown links but keep text
        cleaned = cleaned.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
        
        // Clean up multiple spaces
        cleaned = cleaned.replace(/\s{2,}/g, ' ');
        
        // Remove table formatting for speech
        cleaned = cleaned.replace(/\|/g, ', ');
        cleaned = cleaned.replace(/-+\|/g, '');
        cleaned = cleaned.replace(/\|-+/g, '');
        
        return cleaned.trim();
    }

    function speakResponse(text) {
        if (!audioEnabled || !('speechSynthesis' in window)) return;

        const cleanText = cleanTextForSpeech(text);
        
        if (!cleanText) return;
        
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 0.8;
        
        speechSynthesis.speak(utterance);
    }

    function copyToClipboard(button) {
        const messageContent = button.closest('.message').querySelector('.message-content p').textContent;
        navigator.clipboard.writeText(messageContent).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => button.innerHTML = originalHTML, 2000);
        });
    }

    function logoutUser() {
        if (confirm("Are you sure you want to logout? Your chat history will be saved.")) {
            if (currentUser) saveChatHistory();
            currentUser = null;
            localStorage.removeItem('medAI_currentUser');
            loadGuestData();
            updateUserDisplay();
            statusIndicator.textContent = "You have been logged out";
            setTimeout(() => loginModal.style.display = 'flex', 500);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        initializeApp();

        sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
        newChatBtn.addEventListener('click', createNewChat);

        clearChatBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear this conversation?")) {
                chatHistoryData[currentChatId].messages = [{
                    role: "ai",
                    content: "Hello! I'm your AI medical assistant. How can I help you today?",
                    timestamp: new Date().toISOString()
                }];
                saveChatHistory();
                loadChat(currentChatId);
                statusIndicator.textContent = "Conversation cleared";
            }
        });

        document.getElementById('audioToggleBtn').addEventListener('click', toggleAudioResponses);

        settingsBtn.addEventListener('click', () => settingsMenu.classList.toggle('show'));
        
        // Close settings menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.remove('show');
            }
        });

        // Profile settings click
        document.getElementById('profileSettings').addEventListener('click', () => {
            if (currentUser) {
                document.getElementById('profileName').value = currentUser.name || currentUser.username || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                clearProfileMessages();
                profileModal.style.display = 'flex';
            } else {
                loginModal.style.display = 'flex';
            }
            settingsMenu.classList.remove('show');
        });

        // Other menu items
        document.getElementById('privacyPolicy').addEventListener('click', () => {
            privacyModal.style.display = 'flex';
            settingsMenu.classList.remove('show');
        });

        document.getElementById('contactUs').addEventListener('click', () => {
            contactModal.style.display = 'flex';
            settingsMenu.classList.remove('show');
        });

        document.getElementById('aboutUs').addEventListener('click', () => {
            aboutModal.style.display = 'flex';
            settingsMenu.classList.remove('show');
        });

        document.getElementById('logoutBtn').addEventListener('click', logoutUser);

        userProfile.addEventListener('click', () => {
            if (currentUser) {
                document.getElementById('profileName').value = currentUser.name || currentUser.username || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                clearProfileMessages();
                profileModal.style.display = 'flex';
            } else {
                loginModal.style.display = 'flex';
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            // Close modals when clicking outside
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                
                // Specific handling for verification modal
                if (e.target.id === 'verificationModal') {
                    registerModal.style.display = 'flex';
                    pendingUser = null;
                    verificationCode = '';
                }
                
                // Specific handling for profile modal
                if (e.target.id === 'profileModal') {
                    clearProfileMessages();
                }
            }
            
            // Close sidebar when clicking outside on mobile
            if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });

        // Also add touch events for mobile
        document.addEventListener('touchstart', (e) => {
            // Close sidebar on mobile when touching outside
            if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            }
            
            // Close settings menu on mobile
            if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target) && settingsMenu.classList.contains('show')) {
                settingsMenu.classList.remove('show');
            }
        });

        // Modal close buttons
        ['closeLoginModal', 'closeRegisterModal', 'closePrivacyModal',
            'closeContactModal', 'closeAboutModal', 'closeVerificationModal'].forEach(id => {
                document.getElementById(id).addEventListener('click', () => {
                    document.getElementById(id.replace('close', '').replace('Modal', 'Modal')).style.display = 'none';
                    if (id === 'closeVerificationModal') {
                        registerModal.style.display = 'flex';
                        pendingUser = null;
                        verificationCode = '';
                    }
                });
            });

        // Modal links
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.style.display = 'none';
            registerModal.style.display = 'flex';
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            registerModal.style.display = 'none';
            loginModal.style.display = 'flex';
        });

        // Form submissions
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            loginUser(email, password);
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (password !== confirmPassword) {
                alert("Passwords do not match");
                return;
            }

            if (password.length < 6) {
                alert("Password must be at least 6 characters long");
                return;
            }

            registerUser(name, email, password);
        });
        
        // Setup auto-verification
        setupAutoVerify();
    });
</script>




