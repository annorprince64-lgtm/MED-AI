<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRUGBOT - Medical Assistant</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #10a37f;
            --primary-dark: #0d8c6c;
            --sidebar-bg: #202123;
            --chat-bg: #343541;
            --message-user-bg: #10a37f;
            --message-ai-bg: #444654;
            --text-color: #d1d5db;
            --text-light: #9ca3af;
            --border-color: #4b5563;
            --hover-color: #2d2d3a;
        }
 /* Add these styles to your existing CSS */
.ai-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ai-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    padding: 12px 15px;
    text-align: left;
    font-size: 14px;
}

.ai-table td {
    padding: 10px 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 14px;
}

.ai-table tr:last-child td {
    border-bottom: none;
}

.ai-table tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

.message-content h2,
.message-content h3 {
    margin: 20px 0 10px 0;
    color: #667eea;
    font-weight: 600;
}

.message-content h2 {
    font-size: 1.3em;
    border-bottom: 1px solid rgba(102, 126, 234, 0.3);
    padding-bottom: 5px;
}

.message-content h3 {
    font-size: 1.1em;
    color: #a78bfa;
}

.message-content ul,
.message-content ol {
    margin: 10px 0 10px 20px;
}

.message-content li {
    margin: 5px 0;
    line-height: 1.5;
}
        .message-content p {
    margin-bottom: 12px;
    line-height: 1.6;
}

.message-content strong {
    color: #a78bfa;
    font-weight: 600;
}

.message-content em {
    color: #94a3b8;
    font-style: italic;
}
        body {
            background-color: var(--chat-bg);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Styles - Enhanced */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.3s ease;
            z-index: 10;
            border-right: 1px solid var(--border-color);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .brand-text {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .new-chat-btn {
            margin: 20px;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .new-chat-btn i {
            font-size: 18px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-title {
            padding: 15px 12px 8px;
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-item {
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .history-item.active {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .history-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            overflow: hidden;
        }

        .history-item-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-color);
        }

        .history-item-title {
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            font-weight: 500;
        }

        .history-item-time {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        /* Main Chat Area */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            position: relative;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        #audioToggleBtn {
            position: relative;
        }

        #audioToggleBtn.audio-disabled {
            opacity: 0.5;
        }

        #audioToggleBtn.audio-disabled #audioToggleIcon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            width: 2px;
            height: 20px;
            background-color: #ef4444;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 100%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user-message {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .ai-message .message-avatar {
            background: var(--primary-color);
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
            max-width: 80%;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            border-radius: 18px 18px 5px 18px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-message .message-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-radius: 18px 18px 18px 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 6px 10px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }

        .drug-recommendation {
            background: rgba(16, 163, 127, 0.1);
            padding: 12px 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary-color);
        }

        .disclaimer {
            background: rgba(239, 68, 68, 0.1);
            padding: 12px 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ef4444;
            font-size: 0.9rem;
        }

        /* Enhanced Input Area - Fixed as requested */
        .input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        /* Language button on left */
        .language-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Voice button in middle (biggest) */
        .voice-btn {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
            position: relative;
        }

        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }

        .voice-btn.listening {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Keyboard button on right */
        .keyboard-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .keyboard-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Keyboard input panel - hidden by default */
        .keyboard-panel {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 100;
        }

        .keyboard-panel.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .keyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .keyboard-title {
            font-size: 16px;
            font-weight: 600;
        }

        .close-keyboard {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 18px;
            transition: color 0.2s;
        }

        .close-keyboard:hover {
            color: var(--text-color);
        }

        .keyboard-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .keyboard-text-input {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            min-height: 60px;
            max-height: 150px;
        }

        .keyboard-text-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .keyboard-send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .keyboard-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .language-selector-panel {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .language-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .language-label {
            font-size: 14px;
            color: var(--text-light);
        }

        .language-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            padding: 5px 10px;
            font-size: 14px;
        }

        .status-indicator {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-light);
            min-height: 20px;
        }

        /* Settings Menu */
        .settings-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 200px;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .settings-menu.show {
            display: block;
        }

        .settings-item {
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .settings-item:hover {
            background-color: var(--hover-color);
        }

        .settings-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        /* Modal Styles - Enhanced */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(32, 33, 35, 0.95), rgba(52, 53, 65, 0.95));
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .modal-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-subtitle {
            color: var(--text-light);
            font-size: 14px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-light);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-block {
            width: 100%;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-light);
            font-size: 14px;
        }

        .modal-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .modal-footer a:hover {
            text-decoration: underline;
        }

        /* Enhanced Privacy Policy */
        .policy-section {
            margin-bottom: 25px;
        }

        .policy-section h3 {
            color: var(--text-color);
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            padding-bottom: 5px;
        }

        .policy-section p {
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .policy-list {
            list-style: none;
            padding-left: 0;
        }

        .policy-list li {
            padding: 8px 0;
            color: var(--text-light);
            position: relative;
            padding-left: 25px;
        }

        .policy-list li::before {
            content: 'âœ“';
            color: #667eea;
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        /* Enhanced Contact Us */
        .contact-info {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .contact-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateX(5px);
        }

        .contact-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .contact-details h4 {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .contact-details p {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
                position: absolute;
                top: 12px;
                left: 12px;
                background: none;
                border: none;
                color: var(--text-color);
                font-size: 1.2rem;
                cursor: pointer;
                z-index: 20;
            }

            .chat-header {
                padding-left: 50px;
            }

            .message {
                gap: 10px;
            }

            .message-content {
                max-width: 85%;
            }

            .input-wrapper {
                gap: 10px;
            }

            .voice-btn {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }

            .language-btn,
            .keyboard-btn {
                width: 45px;
                height: 45px;
            }
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 5px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--text-light);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>

<body>
    <!-- Sidebar Toggle for Mobile -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="brand">
                <div class="brand-icon">
                    <i class="fas fa-pills"></i>
                </div>
                <div class="brand-text">DRUGBOT</div>
            </div>
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus-circle"></i>
            New Chat
        </button>

        <div class="chat-history" id="chatHistory">
            <div class="history-title">Today</div>
            <!-- History items will be populated by JavaScript -->
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="userName">Guest User</span>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-container">
        <div class="chat-header">
            <div class="chat-title">DRUGBOT</div>
            <div class="header-actions">
                <button class="header-btn" id="clearChatBtn" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="header-btn" id="settingsBtn" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn" id="audioToggleBtn" title="Toggle audio responses">
                    <i class="fas fa-volume-up" id="audioToggleIcon"></i>
                </button>
                <div class="settings-menu" id="settingsMenu">
                    <div class="settings-item" id="profileSettings">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </div>
                    <div class="settings-item" id="privacyPolicy">
                        <i class="fas fa-shield-alt"></i>
                        <span>Privacy Policy</span>
                    </div>
                    <div class="settings-item" id="contactUs">
                        <i class="fas fa-phone"></i>
                        <span>Contact Us</span>
                    </div>
                    <div class="settings-item" id="aboutUs">
                        <i class="fas fa-info-circle"></i>
                        <span>About Us</span>
                    </div>
                    <div class="settings-divider"></div>
                    <div class="settings-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>Hello! I'm <strong>DRUGBOT</strong>, your AI medical assistant. I can understand Twi and English speech. I can help with medical questions, general knowledge, translations, and more.</p>
                    <p>Click the microphone button below to start speaking, or use the keyboard icon to type your message.</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <!-- Language button on left -->
                <button class="language-btn" id="languageBtn" title="Language settings">
                    <i class="fas fa-globe"></i>
                </button>
                
                <!-- Voice button in middle (biggest) -->
                <button class="voice-btn" id="voiceBtn" title="Start voice input">
                    <i class="fas fa-microphone"></i>
                </button>
                
                <!-- Keyboard button on right -->
                <button class="keyboard-btn" id="keyboardBtn" title="Switch to keyboard">
                    <i class="fas fa-keyboard"></i>
                </button>
            </div>
            
            <!-- Keyboard panel (hidden by default) -->
            <div class="keyboard-panel" id="keyboardPanel">
                <div class="keyboard-header">
                    <div class="keyboard-title">Type your message</div>
                    <button class="close-keyboard" id="closeKeyboard">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="keyboard-input-area">
                    <textarea class="keyboard-text-input" id="keyboardTextInput" placeholder="Type your message here..."></textarea>
                    <button class="keyboard-send-btn" id="keyboardSendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="language-selector-panel">
                    <div class="language-row">
                        <span class="language-label">Input Language:</span>
                        <select class="language-select" id="keyboardLanguageSelect">
                            <option value="en-US">English</option>
                            <option value="ak-GH">Twi</option>
                        </select>
                    </div>
                    <div class="language-row">
                        <span class="language-label">Output Language:</span>
                        <select class="language-select" id="outputLanguageSelect">
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="status-indicator" id="statusIndicator">Ready to chat - Click the microphone to speak</div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-lock"></i>
                </div>
                <h2 class="modal-title">Login to DRUGBOT</h2>
                <p class="modal-subtitle">Access your medical assistant account</p>
                <button class="modal-close" id="closeLoginModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email Address</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i>
                        Login
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                Don't have an account? <a href="#" id="showRegister">Register here</a>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h2 class="modal-title">Create Account</h2>
                <p class="modal-subtitle">Join DRUGBOT today</p>
                <button class="modal-close" id="closeRegisterModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label" for="registerName">Full Name</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email Address</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerConfirmPassword">Confirm Password</label>
                        <input type="password" class="form-input" id="registerConfirmPassword" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-user-plus"></i>
                        Register
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                Already have an account? <a href="#" id="showLogin">Login here</a>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-cog"></i>
                </div>
                <h2 class="modal-title">User Profile</h2>
                <p class="modal-subtitle">Manage your account settings</p>
                <button class="modal-close" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="profileName">Full Name</label>
                    <input type="text" class="form-input" id="profileName" value="Guest User">
                </div>
                <div class="form-group">
                    <label class="form-label" for="profileEmail">Email Address</label>
                    <input type="email" class="form-input" id="profileEmail" value="guest@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="currentPassword">Current Password</label>
                    <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <input type="password" class="form-input" id="newPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                    <input type="password" class="form-input" id="confirmNewPassword" placeholder="Confirm new password">
                </div>
                <button class="btn btn-primary btn-block" id="updateProfileBtn">
                    <i class="fas fa-save"></i>
                    Update Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2 class="modal-title">Privacy Policy</h2>
                <p class="modal-subtitle">Your privacy is our priority</p>
                <button class="modal-close" id="closePrivacyModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="policy-section">
                    <h3>Information We Collect</h3>
                    <p>We collect information you provide directly to us, such as when you create an account, use our services, or contact us for support. This may include:</p>
                    <ul class="policy-list">
                        <li>Personal identification information (name, email address)</li>
                        <li>Medical queries and conversation history</li>
                        <li>Usage data and preferences</li>
                        <li>Device and browser information</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h3>How We Use Your Information</h3>
                    <p>We use the information we collect to provide, maintain, and improve our services, to develop new ones, and to protect DRUGBOT and our users. Specifically:
                        Excellent. Thank you for the clear information. This allows me to refine the privacy policy text to be highly specific, transparent, and compliant.

Here is the professional "Information We Collect" section, updated with your details and structured for clarity and user trust.

---

### **Information We Collect**

DRUGBOT is designed to prioritize your privacy. We collect the minimal amount of information necessary to provide, secure, and improve your AI medical assistance experience. The information we gather falls into the following categories, based on how you interact with our service.

#### **1. Information You Provide Voluntarily**
You directly control most of the information we collect by choosing what to share with the assistant.
*   **Chat Content**: All text and voice input you provide during your conversation with DRUGBOT. This includes questions, descriptions of symptoms, medical history details, and any other information you choose to share to receive a response.
*   **Account Information**: You can use DRUGBOT immediately without an account. If you choose to create an account to sync your chat history across devices, we collect your name and email address.
*   **Contact Information**: If you contact our support team via email or the contact form, we collect your email address and the contents of your message.
*   **Verification Data**: If you choose to verify your account or subscribe, we use your email address solely to send a one-time verification code via our trusted email service provider, EmailJS.

#### **2. Information Collected for Core Service Operation**
Certain information is generated automatically to make the service function securely and reliably.
*   **Technical & Log Data**: This includes your device's IP address, browser type and version, operating system, and the dates/times of your access. This data is essential for security, preventing abuse, and diagnosing technical issues.
*   **Usage Data**: We collect anonymized, high-level data about feature usage (e.g., frequency of voice vs. text input, language selection) to understand how DRUGBOT is used and guide future improvements. This is not linked to your identity or chat content.
*   **Local Storage Data**: To enhance your experience, we store certain data locally on your device using your browser's local storage. This includes your active chat history, your preference for text or voice input, and selected language. **You can clear this data at any time by clearing your browser's site data.**

#### **3. Sensitive Health & Biometric Information**
By its nature, DRUGBOT facilitates conversations about health, which involves sensitive data. We handle this information with the utmost care.
*   **Health Information**: Information you share about physical or mental health conditions, symptoms, medications, treatments, or medical history is classified as "Special Category Data" under regulations like the GDPR. We process this data solely to provide the AI-powered medical information service you request.
*   **Audio/Biometric Data (Local Processing)**: When you use the voice input feature, your speech is **processed directly on your device** to convert it to text. The audio recording is **not transmitted to or stored on our servers**. Only the resulting text from the conversion is sent to our AI service to generate a response.

#### **4. Information Processed by Our Service Providers**
We engage reputable third-party service providers to perform specific functions. They access only the information necessary for their task and are contractually forbidden from using it for any other purpose.
*   **AI Processing (Grok API)**: The text of your queries is sent to our AI service provider to generate a response. Our contract with them ensures this data is used only for this purpose.
*   **Email Delivery (EmailJS)**: Your email address is shared with EmailJS solely for the purpose of sending account verification or subscription emails.
*   **Analytics (Future Implementation)**: We currently do not use analytics services like Google Analytics. **If implemented in the future, this section will be updated prior to activation, and you will be provided with a clear option to opt-out.**

To summarize the data flow and purposes clearly, the following table provides an overview:

| Category of Information | Specific Data Points | Primary Purpose & Legal Basis |
| :--- | :--- | :--- |
| **Voluntary Input** | Chat messages, symptom details, account email. | **Purpose:** To provide the core AI medical response. <br> **Basis:** Your consent through use. |
| **Sensitive Health Data** | Medical conditions, medications, treatments. | **Purpose:** To generate a context-aware, informed response. <br> **Basis:** Explicit consent for the healthcare service. |
| **Service Operation Data** | IP Address, device type, browser, local chat history. | **Purpose:** Security, functionality, and personalization (via local storage). <br> **Basis:** Legitimate interest in a secure, functional service. |
| **Third-Party Processed Data** | Query text (to AI API), email address (to EmailJS). | **Purpose:** Core service delivery and user verification. <br> **Basis:** Contractual necessity with strict data processing agreements. |

**Important Legal Disclaimer**: This drafted section is based on standard best practices for transparency. Because DRUGBOT handles sensitive health information, it is **strongly recommended** that you consult with a legal professional to ensure full compliance with applicable data protection laws such as the **GDPR** (General Data Protection Regulation), **HIPAA** (Health Insurance Portability and Accountability Act, if applicable in the U.S.), or your local regulations before final publication.


                    </p>
                    <ul class="policy-list">
                        <li>To provide personalized medical assistance</li>
                        <li>To improve AI algorithms and response accuracy</li>
                        <li>To ensure platform security and prevent abuse</li>
                        <li>To communicate important updates and information</li>
                        <li>To comply with legal obligations</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h3>Data Security</h3>
                    <p>We implement industry-standard security measures to protect your personal information. All data is encrypted in transit and at rest. Your medical conversations are treated with strict confidentiality.</p>
                </div>

                <div class="policy-section">
                    <h3>Your Rights</h3>
                    <p>You have the right to access, correct, or delete your personal information. You can manage your data through your account settings or by contacting us directly.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Us Modal -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-headset"></i>
                </div>
                <h2 class="modal-title">Contact Us</h2>
                <p class="modal-subtitle">We're here to help you 24/7</p>
                <button class="modal-close" id="closeContactModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: var(--text-light); margin-bottom: 25px;">
                    Have questions or need support? Reach out to our team through any of the following channels:
                </p>

                <div class="contact-info">
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Primary Contact</h4>
                            <p>+233 257 477 888</p>
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Secondary Contact</h4>
                            <p>+233 534 111 407</p>
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Email Support</h4>
                            <p>yeboahcollins754@gmail.com</p>
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-details">
                            <h4>Technical Support</h4>
                            <p>annorprince64@gmail.com</p>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px;">
                    <h4 style="color: var(--text-color); margin-bottom: 10px; font-size: 16px;">Response Time</h4>
                    <p style="color: var(--text-light); font-size: 14px; line-height: 1.6;">
                        <i class="fas fa-clock" style="margin-right: 8px;"></i>
                        We typically respond to all inquiries within 24 hours. For emergency medical issues, please contact local healthcare providers immediately.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- About Us Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h2 class="modal-title">About DRUGBOT</h2>
                <p class="modal-subtitle">Your AI Medical Companion</p>
                <button class="modal-close" id="closeAboutModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="policy-section">
                    <h3>Our Mission</h3>
                    <p>DRUGBOT is an advanced AI-powered medical assistant designed to make healthcare information accessible, understandable, and actionable for everyone. Our mission is to bridge the gap between medical knowledge and everyday health decisions.</p>
                </div>

                <div class="policy-section">
                    <h3>Key Features</h3>
                    <ul class="policy-list">
                        <li>Multilingual support (Twi and English)</li>
                        <li>Voice recognition for hands-free operation</li>
                        <li>Medical information and drug recommendations</li>
                        <li>Secure and private conversations</li>
                        <li>24/7 availability for health queries</li>
                        <li>Translation services for medical terms</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h3>Important Disclaimer</h3>
                    <p>DRUGBOT is an AI assistant designed to provide medical information and suggestions. It is not a substitute for professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare providers for medical concerns.</p>
                </div>

                <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; border-left: 4px solid #667eea;">
                    <h4 style="color: var(--text-color); margin-bottom: 10px;">Developed With passion</h4>
                    <p style="color: var(--text-light);">
                        By Annor Prince and Collins Yeboah<br>
                        <span style="font-size: 13px;">Dedicated to improving healthcare accessibility</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div class="modal" id="verificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-mail-bulk"></i>
                </div>
                <h2 class="modal-title">Verify Your Email</h2>
                <p class="modal-subtitle">Check your inbox for the verification code</p>
                <button class="modal-close" id="closeVerificationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 30px;">
                    <p style="color: var(--text-light); margin-bottom: 20px;">
                        We've sent a 6-digit verification code to your email address. Please enter it below to complete your registration.
                    </p>
                    
                    <input type="text" id="verificationCodeInput" class="form-input" 
                           placeholder="Enter 6-digit code" maxlength="6" 
                           style="text-align: center; font-size: 24px; letter-spacing: 10px; padding: 15px; width: 200px;">
                </div>

                <div id="verificationError" style="display: none; text-align: center; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid #ef4444; margin: 15px 0;">
                    <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                    Invalid verification code. Please try again.
                </div>

                <div id="verificationSuccess" style="display: none; text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border-left: 4px solid #10b981; margin: 15px 0;">
                    <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                    Email verified successfully! Welcome to DRUGBOT.
                </div>
            </div>
        </div>
    </div>

    <!-- COPY EXACT JAVASCRIPT FROM ORIGINAL FILE -->
    <script type="text/javascript">
        (function () {
            emailjs.init("lTUvDRylLKuYhqt9o");
        })();
    </script>

    <script>
        // Backend API Configuration
        const BACKEND_URL = 'https://med-ai-48yi.onrender.com/api/analyze';
        const AUTH_URL = 'https://med-ai-48yi.onrender.com/api';

        // DOM Elements - Updated for new input system
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatContainer = document.getElementById('chatContainer');
        const chatHistory = document.getElementById('chatHistory');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsMenu = document.getElementById('settingsMenu');
        const userProfile = document.getElementById('userProfile');
        const userName = document.getElementById('userName');
        
        // New input system elements
        const languageBtn = document.getElementById('languageBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const keyboardBtn = document.getElementById('keyboardBtn');
        const keyboardPanel = document.getElementById('keyboardPanel');
        const closeKeyboard = document.getElementById('closeKeyboard');
        const keyboardTextInput = document.getElementById('keyboardTextInput');
        const keyboardSendBtn = document.getElementById('keyboardSendBtn');
        const keyboardLanguageSelect = document.getElementById('keyboardLanguageSelect');
        const outputLanguageSelect = document.getElementById('outputLanguageSelect');

        // Modal elements
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const profileModal = document.getElementById('profileModal');
        const privacyModal = document.getElementById('privacyModal');
        const contactModal = document.getElementById('contactModal');
        const aboutModal = document.getElementById('aboutModal');
        const verificationModal = document.getElementById('verificationModal');

        // Email Verification State
        let verificationCode = '';
        let pendingUser = null;

        // Application State
        let currentUser = null;
        let currentChatId = generateChatId();
        let chatHistoryData = {};
        let isListening = false;
        let recognition;
        let audioEnabled = true;

        // Initialize speech recognition
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function () {
                    isListening = true;
                    voiceBtn.classList.add('listening');
                    statusIndicator.textContent = "Listening... Speak now";
                };

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript.trim();
                    if (transcript) {
                        processUserInput(transcript);
                        statusIndicator.textContent = `Heard: "${transcript}"`;
                    }
                };

                recognition.onerror = function (event) {
                    console.error('Speech recognition error', event.error);
                    let errorMsg = `Error: ${event.error}`;

                    if (event.error === 'no-speech') {
                        errorMsg = "No speech detected. Please try again.";
                    } else if (event.error === 'audio-capture') {
                        errorMsg = "No microphone found. Ensure it is plugged in.";
                    } else if (event.error === 'not-allowed') {
                        errorMsg = "Microphone permission denied.";
                    }

                    statusIndicator.textContent = errorMsg;
                    resetListeningState();
                };

                recognition.onend = function () {
                    resetListeningState();
                };
            } else {
                statusIndicator.textContent = "Speech recognition not supported in this browser";
            }
        }

        function resetListeningState() {
            isListening = false;
            voiceBtn.classList.remove('listening');
            if (statusIndicator.textContent.startsWith("Listening")) {
                statusIndicator.textContent = "Ready to chat - Click microphone to speak";
            }
        }

        function toggleListening() {
            if (!recognition) {
                alert('Speech recognition not supported in your browser');
                return;
            }

            if (isListening) {
                recognition.stop();
                resetListeningState();
            } else {
                try {
                    recognition.lang = keyboardLanguageSelect.value;
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    statusIndicator.textContent = "Error starting voice recognition";
                }
            }
        }

        // Keyboard panel functionality
        function showKeyboardPanel() {
            keyboardPanel.classList.add('active');
            keyboardTextInput.focus();
            statusIndicator.textContent = "Keyboard mode - Type your message";
        }

        function hideKeyboardPanel() {
            keyboardPanel.classList.remove('active');
            keyboardTextInput.value = '';
            statusIndicator.textContent = "Ready to chat - Click microphone to speak";
        }

        function sendKeyboardMessage() {
            const text = keyboardTextInput.value.trim();
            if (text) {
                processUserInput(text);
                keyboardTextInput.value = '';
                hideKeyboardPanel();
            }
        }

        // Initialize the app
        function initializeApp() {
            // Load audio preference
            const savedAudio = localStorage.getItem('medAI_audioEnabled');
            if (savedAudio !== null) {
                audioEnabled = savedAudio === 'true';
                const btn = document.getElementById('audioToggleBtn');
                const icon = document.getElementById('audioToggleIcon');
                if (!audioEnabled) {
                    btn.classList.add('audio-disabled');
                    icon.className = 'fas fa-volume-mute';
                }
            }

            // Initialize speech recognition
            initializeSpeechRecognition();

            // Check if user is already logged in
            const savedUser = localStorage.getItem('medAI_currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateUserDisplay();
                    loadUserChatHistory(currentUser.id);
                } catch (e) {
                    console.error('Error loading user:', e);
                    loadGuestData();
                }
            } else {
                loadGuestData();
            }

            // Setup event listeners for new input system
            setupInputEventListeners();
        }

        function setupInputEventListeners() {
            // Voice button
            voiceBtn.addEventListener('click', toggleListening);
            
            // Keyboard button
            keyboardBtn.addEventListener('click', showKeyboardPanel);
            
            // Close keyboard panel
            closeKeyboard.addEventListener('click', hideKeyboardPanel);
            
            // Send button in keyboard panel
            keyboardSendBtn.addEventListener('click', sendKeyboardMessage);
            
            // Enter key in keyboard panel
            keyboardTextInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendKeyboardMessage();
                }
            });
            
            // Language selection
            keyboardLanguageSelect.addEventListener('change', function () {
                if (recognition) {
                    recognition.lang = this.value;
                }
            });
        }

        // ==================== PASTE ALL ORIGINAL JAVASCRIPT FUNCTIONS BELOW ====================
        // Password hashing function
        function hashPassword(password) {
            return btoa(unescape(encodeURIComponent(password)));
        }

        // Validate password
        function validatePassword(inputPassword, storedPassword) {
            return hashPassword(inputPassword) === storedPassword;
        }

        // ============================================
        // EMAIL VERIFICATION FUNCTIONS
        // ============================================
        async function sendVerificationEmail(email, code) {
            console.log(`[EMAIL] Sending verification email to: ${email} with code: ${code}`);
            return new Promise((resolve) => {
                emailjs.send('service_zjhyid5', 'template_vha29yp', {
                    to_email: email,
                    verification_code: code,
                }).then(
                    function (response) {
                        console.log('[EMAIL] Email sent successfully:', response.status, response.text);
                        resolve(true);
                    },
                    function (error) {
                        console.error('[EMAIL] Failed to send email:', error);
                        alert('Failed to send verification email. Please check your email address and try again.');
                        resolve(false);
                    }
                );
            });
        }

        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function setupAutoVerify() {
            const input = document.getElementById('verificationCodeInput');
            const errorDiv = document.getElementById('verificationError');
            const successDiv = document.getElementById('verificationSuccess');

            if (!input) return;

            input.addEventListener('input', function (e) {
                this.value = this.value.replace(/[^0-9]/g, '');

                if (this.value.length === 6) {
                    const enteredCode = this.value;

                    if (enteredCode === verificationCode) {
                        errorDiv.style.display = 'none';
                        successDiv.style.display = 'block';
                        input.disabled = true;
                        input.style.borderColor = 'var(--primary-color)';

                        setTimeout(() => {
                            completeRegistration();
                        }, 1000);
                    } else {
                        successDiv.style.display = 'none';
                        errorDiv.style.display = 'block';
                        input.value = '';
                        input.focus();
                    }
                }
            });
        }

        // Toggle audio responses
        function toggleAudioResponses() {
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audioToggleBtn');
            const icon = document.getElementById('audioToggleIcon');

            if (audioEnabled) {
                btn.classList.remove('audio-disabled');
                icon.className = 'fas fa-volume-up';
                statusIndicator.textContent = 'Audio responses enabled';
            } else {
                btn.classList.add('audio-disabled');
                icon.className = 'fas fa-volume-mute';
                statusIndicator.textContent = 'Audio responses disabled';
            }

            localStorage.setItem('medAI_audioEnabled', audioEnabled);
            setTimeout(() => {
                statusIndicator.textContent = 'Ready to chat';
            }, 2000);
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function updateUserDisplay() {
            if (!currentUser) {
                userName.textContent = 'Guest User';
                return;
            }

            console.log('[USER] Current user object:', currentUser);
            console.log('[USER] Available properties:', Object.keys(currentUser));

            const nameProperty = currentUser.name || currentUser.username || currentUser.fullName || 'User';
            console.log('[USER] Using name property:', nameProperty);

            const nameParts = nameProperty.toString().trim().split(' ');
            const surname = nameParts[nameParts.length - 1];
            userName.textContent = surname || 'User';
            
            console.log('[USER] Display name set to:', userName.textContent);
        }

        async function loginUser(email, password) {
            console.log('[AUTH] Login attempt for:', email);
            
            const loginBtn = document.querySelector('#loginForm .btn-primary');
            const originalText = loginBtn.textContent;
            
            try {
                // Show loading state
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                loginBtn.disabled = true;

                const response = await fetch(`${AUTH_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('[AUTH] Login successful');
                    currentUser = result.user;
                    localStorage.setItem('medAI_currentUser', JSON.stringify(currentUser));
                    
                    updateUserDisplay();
                    loadUserChatHistory(currentUser.id);

                    // Show success feedback
                    loginBtn.innerHTML = '<i class="fas fa-check"></i> Success!';
                    loginBtn.style.backgroundColor = '#10a37f';
                    
                    setTimeout(() => {
                        loginModal.style.display = 'none';
                        statusIndicator.textContent = `Welcome back, ${userName.textContent}!`;
                        // Reset button
                        loginBtn.textContent = originalText;
                        loginBtn.disabled = false;
                        loginBtn.style.backgroundColor = '';
                        document.getElementById('loginForm').reset();
                    }, 1000);

                } else {
                    throw new Error(result.error || "Invalid email or password");
                }
            } catch (error) {
                console.error('[AUTH] Login error:', error);
                
                // Show error feedback
                loginBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
                loginBtn.style.backgroundColor = '#ef4444';
                
                setTimeout(() => {
                    alert(error.message || "Login failed. Please check your connection and try again.");
                    loginBtn.textContent = originalText;
                    loginBtn.disabled = false;
                    loginBtn.style.backgroundColor = '';
                }, 1000);
            }
        }

        async function registerUser(name, email, password) {
            console.log('[AUTH] Registration attempt for:', email);

            const registerBtn = document.querySelector('#registerForm .btn-primary');
            const originalText = registerBtn.textContent;

            try {
                // Show loading state
                registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
                registerBtn.disabled = true;

                // Generate verification code
                verificationCode = generateVerificationCode();
                console.log('[AUTH] Generated verification code:', verificationCode);

                // Send verification email
                const emailSent = await sendVerificationEmail(email, verificationCode);
                
                if (!emailSent) {
                    throw new Error('Failed to send verification email');
                }

                // Store pending user data
                pendingUser = { name, email, password };

                // Show verification modal
                registerModal.style.display = 'none';
                verificationModal.style.display = 'flex';
                
                // Reset verification input
                const input = document.getElementById('verificationCodeInput');
                const errorDiv = document.getElementById('verificationError');
                const successDiv = document.getElementById('verificationSuccess');
                
                input.value = '';
                input.disabled = false;
                input.style.borderColor = '';
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                
                input.focus();

                // Reset register button
                registerBtn.textContent = originalText;
                registerBtn.disabled = false;

            } catch (error) {
                console.error('[AUTH] Registration error:', error);
                
                // Show error feedback
                registerBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
                registerBtn.style.backgroundColor = '#ef4444';
                
                setTimeout(() => {
                    alert(error.message || 'Registration failed. Please try again.');
                    registerBtn.textContent = originalText;
                    registerBtn.disabled = false;
                    registerBtn.style.backgroundColor = '';
                }, 1000);
            }
        }

        async function completeRegistration() {
            if (!pendingUser) return;

            console.log('[REGISTRATION] Completing registration for:', pendingUser.email);

            try {
                const response = await fetch(`${AUTH_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: pendingUser.name,
                        email: pendingUser.email,
                        password: pendingUser.password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('[AUTH] Registration successful');
                    currentUser = result.user;
                    localStorage.setItem('medAI_currentUser', JSON.stringify(currentUser));

                    updateUserDisplay();
                    loadUserChatHistory(currentUser.id);

                    verificationModal.style.display = 'none';
                    statusIndicator.textContent = `Welcome to DRUGBOT, ${userName.textContent}!`;

                    document.getElementById('registerForm').reset();
                    pendingUser = null;
                    verificationCode = '';
                } else {
                    throw new Error(result.error || 'Registration failed after verification.');
                }
            } catch (error) {
                console.error('[AUTH] Final registration error:', error);
                alert('Registration failed after verification. Please try again.');
                verificationModal.style.display = 'none';
                registerModal.style.display = 'flex';
            }
        }

        async function updateUserProfile(name, email, currentPassword, newPassword) {
            if (!currentUser) {
                alert("Please login first");
                return;
            }

            const updateBtn = document.getElementById('updateProfileBtn');
            const originalText = updateBtn.textContent;

            try {
                // Show loading state
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                updateBtn.disabled = true;

                // Validate the update request
                const validationError = validateProfileUpdate(name, email, currentPassword, newPassword);
                if (validationError) {
                    throw new Error(validationError);
                }

                // Prepare update data - ALWAYS send originalEmail to identify user
                const updateData = {
                    originalEmail: currentUser.email,  // â­ THIS IDENTIFIES THE USER â­
                };
                
                // Add name if changed
                const currentName = currentUser.name || currentUser.username;
                if (name !== currentName) {
                    updateData.name = name;
                }
                
                // Add email if changed (send as newEmail)
                if (email !== currentUser.email) {
                    updateData.newEmail = email;
                }

                // Add password fields if changing password
                if (newPassword) {
                    if (!currentPassword) {
                        throw new Error("Please provide your current password to change your password");
                    }
                    updateData.currentPassword = currentPassword;
                    updateData.newPassword = newPassword;
                }

                // If nothing to update, show message
                if (Object.keys(updateData).length === 1) { // Only has originalEmail
                    throw new Error("No changes detected");
                }

                console.log('[PROFILE] Sending update data:', updateData);

                const response = await fetch(`${AUTH_URL}/update-profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    console.log('[PROFILE] Update successful');
                    currentUser = result.user;
                    localStorage.setItem('medAI_currentUser', JSON.stringify(currentUser));

                    updateUserDisplay();

                    // Show success feedback
                    updateBtn.innerHTML = '<i class="fas fa-check"></i> Updated!';
                    updateBtn.style.backgroundColor = '#10a37f';
                    
                    setTimeout(() => {
                        profileModal.style.display = 'none';
                        statusIndicator.textContent = "Profile updated successfully";
                        
                        // Reset button and form
                        updateBtn.textContent = originalText;
                        updateBtn.disabled = false;
                        updateBtn.style.backgroundColor = '';
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmNewPassword').value = '';
                    }, 1000);

                } else {
                    throw new Error(result.error || "Profile update failed");
                }
            } catch (error) {
                console.error('[PROFILE] Update error:', error);
                
                // Show error feedback
                updateBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
                updateBtn.style.backgroundColor = '#ef4444';
                
                setTimeout(() => {
                    alert(error.message || "Profile update failed. Please try again.");
                    updateBtn.textContent = originalText;
                    updateBtn.disabled = false;
                    updateBtn.style.backgroundColor = '';
                }, 1000);
            }
        }
function createInitialChat() {
    currentChatId = generateChatId();
    chatHistoryData = {
        [currentChatId]: {
            id: currentChatId,
            title: "Welcome to DRUGBOT",
            date: new Date().toISOString(),
            messages: [
                {
                    role: "ai",
                    content: "Hello! I'm your AI medical assistant. How can I help you today?",
                    timestamp: new Date().toISOString()
                }
            ]
        }
    };
    console.log('[INIT] Created initial chat with ID:', currentChatId);
}
        function validateProfileUpdate(name, email, currentPassword, newPassword) {
            // Basic validation
            if (!name.trim()) {
                return "Name is required";
            }
            
            if (!email.trim()) {
                return "Email is required";
            }
            
            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return "Please enter a valid email address";
            }
            
            // Password validation (only if trying to change password)
            if (newPassword) {
                if (!currentPassword) {
                    return "Current password is required to change your password";
                }
                
                if (newPassword.length < 6) {
                    return "New password must be at least 6 characters long";
                }
            }
            
            return null; // No errors
        }

        function logoutUser() {
            console.log('[AUTH] Logging out user:', currentUser?.email);

            if (confirm("Are you sure you want to logout? Your chat history will be saved.")) {
                if (currentUser) {
                    saveChatHistory();
                }

                currentUser = null;
                localStorage.removeItem('medAI_currentUser');

                loadGuestData();
                updateUserDisplay();
                statusIndicator.textContent = "You have been logged out";

                setTimeout(() => {
                    loginModal.style.display = 'flex';
                }, 500);
            }
        }

        // ============================================
        // INITIALIZATION & CORE FUNCTIONS
        // ============================================
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ============================================
        // CHAT HISTORY FUNCTIONS
        // ============================================
       async function loadUserChatHistory(userId) {
    console.log('[USER] Loading chat history for user:', userId);
    
    if (userId) {
        try {
            // Try to load from cloud first
            const response = await fetch(`${AUTH_URL}/chats/load?user_id=${userId}`);
            const result = await response.json();
            
            if (result.success && result.chats && Object.keys(result.chats).length > 0) {
                chatHistoryData = result.chats;
                console.log('[CLOUD] Loaded from cloud:', Object.keys(chatHistoryData).length, 'chats');
            } else {
                // Fallback to local storage
                const userHistoryKey = `medAI_chatHistory_${userId}`;
                const savedHistory = localStorage.getItem(userHistoryKey);
                
                if (savedHistory) {
                    chatHistoryData = JSON.parse(savedHistory);
                    console.log('[USER] Loaded from local storage');
                } else {
                    console.log('[USER] No existing history, creating initial chat');
                    createInitialChat();
                }
            }
        } catch (error) {
            console.error('[CLOUD] Error loading from cloud, using local:', error);
            const userHistoryKey = `medAI_chatHistory_${userId}`;
            const savedHistory = localStorage.getItem(userHistoryKey);
            
            if (savedHistory) {
                chatHistoryData = JSON.parse(savedHistory);
            } else {
                createInitialChat();
            }
        }
    } else {
        loadGuestData();
    }

    renderChatHistory();
    loadChat(currentChatId);
}

        function loadGuestData() {
            console.log('[GUEST] Loading guest data');
            const savedHistory = localStorage.getItem('medAI_guestHistory');

            if (savedHistory) {
                chatHistoryData = JSON.parse(savedHistory);
                console.log('[GUEST] Loaded guest chat history');
            } else {
                console.log('[GUEST] Creating initial guest chat');
                chatHistoryData = {
                    [currentChatId]: {
                        id: currentChatId,
                        title: "DRUGBOT Assistant",
                        date: new Date().toISOString(),
                        messages: [
                            {
                                role: "ai",
                                content: "Hello! I'm your AI medical assistant. I can understand Twi and English speech. I can help with medical questions, general knowledge, translations, and more. Select your language and either type your message or use the voice button to speak to me.",
                                timestamp: new Date().toISOString()
                            }
                        ]
                    }
                };
                saveChatHistory();
            }

            renderChatHistory();
            loadChat(currentChatId);
        }

      async function saveChatHistory() {
    console.log('[SAVE] Saving chat history, currentUser:', currentUser);

    if (currentUser) {
        const userHistoryKey = `medAI_chatHistory_${currentUser.id}`;
        localStorage.setItem(userHistoryKey, JSON.stringify(chatHistoryData));
        console.log('[SAVE] Saved to user storage:', userHistoryKey);
        
        // Try to save to cloud
        try {
            const chatData = chatHistoryData[currentChatId];
            if (chatData) {
                const response = await fetch(`${AUTH_URL}/chats/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        chat_data: chatData
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('[CLOUD] Chat saved to cloud successfully');
                }
            }
        } catch (error) {
            console.error('[CLOUD] Error saving to cloud:', error);
            // Continue with local storage only
        }
    } else {
        localStorage.setItem('medAI_guestHistory', JSON.stringify(chatHistoryData));
        console.log('[SAVE] Saved to guest storage');
    }
}

        function renderChatHistory() {
            chatHistory.innerHTML = '';

            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            const todayChats = [];
            const yesterdayChats = [];
            const olderChats = [];

            Object.values(chatHistoryData).forEach(chat => {
                const chatDate = new Date(chat.date).toDateString();

                if (chatDate === today) {
                    todayChats.push(chat);
                } else if (chatDate === yesterday) {
                    yesterdayChats.push(chat);
                } else {
                    olderChats.push(chat);
                }
            });

            if (todayChats.length > 0) {
                const todayTitle = document.createElement('div');
                todayTitle.className = 'history-title';
                todayTitle.textContent = 'Today';
                chatHistory.appendChild(todayTitle);

                todayChats.forEach(chat => {
                    chatHistory.appendChild(createHistoryItem(chat));
                });
            }

            if (yesterdayChats.length > 0) {
                const yesterdayTitle = document.createElement('div');
                yesterdayTitle.className = 'history-title';
                yesterdayTitle.textContent = 'Yesterday';
                chatHistory.appendChild(yesterdayTitle);

                yesterdayChats.forEach(chat => {
                    chatHistory.appendChild(createHistoryItem(chat));
                });
            }

            if (olderChats.length > 0) {
                const olderTitle = document.createElement('div');
                olderTitle.className = 'history-title';
                olderTitle.textContent = 'Previous 7 Days';
                chatHistory.appendChild(olderTitle);

                olderChats.forEach(chat => {
                    chatHistory.appendChild(createHistoryItem(chat));
                });
            }
        }

        function createHistoryItem(chat) {
            const historyItem = document.createElement('div');
            historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
            historyItem.dataset.chatId = chat.id;

            const itemContent = document.createElement('div');
            itemContent.className = 'history-item-content';

            const icon = document.createElement('i');
            icon.className = 'fas fa-message';

            const title = document.createElement('span');
            title.className = 'history-item-title';
            title.textContent = chat.title;

            itemContent.appendChild(icon);
            itemContent.appendChild(title);
            historyItem.appendChild(itemContent);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.style.opacity = '0.5';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            };
            historyItem.appendChild(deleteBtn);

            historyItem.addEventListener('click', () => {
                loadChat(chat.id);
            });

            return historyItem;
        }

        function loadChat(chatId) {
            console.log('[CHAT] Loading chat:', chatId);

            document.querySelectorAll('.history-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.history-item[data-chat-id="${chatId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            currentChatId = chatId;
            chatContainer.innerHTML = '';

            const chat = chatHistoryData[chatId];
            if (chat && chat.messages) {
                console.log('[CHAT] Loading', chat.messages.length, 'messages');
                chat.messages.forEach(message => {
                    addMessageToChat(
                        message.content,
                        message.role === 'user',
                        false,
                        false,
                        message.isMedical,
                        message.drugRecommendation,
                        message.disclaimer,
                        false
                    );
                });
            }

            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }

            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        function deleteChat(chatId) {
            if (Object.keys(chatHistoryData).length === 1) {
                alert('You cannot delete your only chat.');
                return;
            }

            if (confirm('Are you sure you want to delete this chat?')) {
                delete chatHistoryData[chatId];
                saveChatHistory();
                renderChatHistory();

                if (chatId === currentChatId) {
                    const remainingChatIds = Object.keys(chatHistoryData);
                    if (remainingChatIds.length > 0) {
                        loadChat(remainingChatIds[0]);
                    }
                }
            }
        }
function renderMarkdown(text) {
    if (!text) return '';
    
    // Split into lines for processing
    const lines = text.split('\n');
    let result = [];
    let i = 0;
    let inTable = false;
    let tableRows = [];
    
    while (i < lines.length) {
        const line = lines[i];
        const trimmedLine = line.trim();
        
        // Handle tables
        if (trimmedLine.includes('|') && !inTable) {
            inTable = true;
            tableRows = [line];
            i++;
            continue;
        }
        
        if (inTable) {
            if (trimmedLine.includes('|')) {
                tableRows.push(line);
                i++;
                continue;
            } else {
                // End of table found, process it
                processTable();
                inTable = false;
                // Don't increment i, process this line normally
                continue;
            }
        }
        
        // Process regular lines
        processRegularLine();
        i++;
    }
    
    // Process any remaining table at the end
    if (inTable && tableRows.length > 0) {
        processTable();
    }
    
    // Join results
    let html = result.join('');
    
    // Clean up
    html = html.replace(/<br>\s*<br>/g, '<br><br>');
    
    return html;
    
    // Helper functions
    function processTable() {
        if (tableRows.length < 2) {
            // Not a valid table, add as plain text
            result.push(tableRows.join('<br>') + '<br>');
            tableRows = [];
            return;
        }
        
        let tableHtml = '<table class="ai-table"><tbody>';
        let isFirstRow = true;
        let hasHeaderSeparator = false;
        
        // Check if second row is a separator
        if (tableRows.length > 1 && /^[\s\|:-]+$/.test(tableRows[1].trim())) {
            hasHeaderSeparator = true;
        }
        
        for (let rowIndex = 0; rowIndex < tableRows.length; rowIndex++) {
            const row = tableRows[rowIndex];
            
            // Skip separator rows
            if (/^[\s\|:-]+$/.test(row.trim())) {
                continue;
            }
            
            const cells = row.split('|')
                .map(cell => cell.trim())
                .filter(cell => cell !== '');
            
            if (cells.length === 0) continue;
            
            tableHtml += '<tr>';
            
            for (let cellIndex = 0; cellIndex < cells.length; cellIndex++) {
                let cellContent = cells[cellIndex];
                
                // Apply basic formatting
                cellContent = cellContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                cellContent = cellContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                if ((rowIndex === 0 && !hasHeaderSeparator) || 
                    (rowIndex === 1 && hasHeaderSeparator)) {
                    tableHtml += `<th>${cellContent}</th>`;
                } else {
                    tableHtml += `<td>${cellContent}</td>`;
                }
            }
            
            tableHtml += '</tr>';
        }
        
        tableHtml += '</tbody></table>';
        result.push(tableHtml);
        tableRows = [];
    }
    
    function processRegularLine() {
        let processedLine = line;
        
        // Handle headers - MUST COME FIRST
        if (trimmedLine.startsWith('### ')) {
            result.push(`<h3>${trimmedLine.substring(4)}</h3>`);
            return;
        }
        
        if (trimmedLine.startsWith('## ')) {
            result.push(`<h2>${trimmedLine.substring(3)}</h2>`);
            return;
        }
        
        // Handle lists
        if (trimmedLine.match(/^[-*]\s+/)) {
            let listHtml = '<ul>';
            while (i < lines.length && lines[i].trim().match(/^[-*]\s+/)) {
                let item = lines[i].trim().substring(2).trim();
                item = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                item = item.replace(/\*(.*?)\*/g, '<em>$1</em>');
                listHtml += `<li>${item}</li>`;
                i++;
            }
            listHtml += '</ul>';
            result.push(listHtml);
            i--; // Adjust since we incremented in the loop
            return;
        }
        
        // Handle numbered lists
        if (trimmedLine.match(/^\d+\.\s+/)) {
            let listHtml = '<ol>';
            while (i < lines.length && lines[i].trim().match(/^\d+\.\s+/)) {
                let item = lines[i].trim().replace(/^\d+\.\s+/, '').trim();
                item = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                item = item.replace(/\*(.*?)\*/g, '<em>$1</em>');
                listHtml += `<li>${item}</li>`;
                i++;
            }
            listHtml += '</ol>';
            result.push(listHtml);
            i--; // Adjust since we incremented in the loop
            return;
        }
        
        // Handle regular text
        if (trimmedLine.length > 0) {
            // Apply inline formatting
            processedLine = processedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            processedLine = processedLine.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Check if this is part of a paragraph
            if (result.length > 0 && result[result.length - 1].endsWith('</p>') === false) {
                // Add to existing paragraph
                result[result.length - 1] = result[result.length - 1].replace(/<\/p>$/, '');
                result[result.length - 1] += `<br>${processedLine}</p>`;
            } else {
                // Start new paragraph
                result.push(`<p>${processedLine}</p>`);
            }
        } else {
            // Empty line - add spacing
            if (result.length > 0) {
                result.push('<br>');
            }
        }
    }

        function createNewChat() {
            currentChatId = generateChatId();
            chatHistoryData[currentChatId] = {
                id: currentChatId,
                title: "New Conversation",
                date: new Date().toISOString(),
                messages: [
                    {
                        role: "ai",
                        content: "Hello! I'm your AI medical assistant. How can I help you today?",
                        timestamp: new Date().toISOString()
                    }
                ]
            };

            saveChatHistory();
            renderChatHistory();
            loadChat(currentChatId);
            statusIndicator.textContent = "New chat created";
        }

        function addMessageToChat(content, isUser = false, isTyping = false, isError = false, isMedical = false, drugRecommendation = null, disclaimer = null, saveToHistory = true) {
            const messageDiv = document.createElement('div');
            let messageClass = `message ${isUser ? 'user-message' : 'ai-message'}`;
            if (isMedical) messageClass += ' medical-message';
            if (isError) messageClass += ' error-message';
            messageDiv.className = messageClass;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${isUser ? 'user-avatar' : 'ai-avatar'}`;
            avatarDiv.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isTyping) {
                contentDiv.innerHTML = 'Thinking<span class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>';
            } else {
   // Always use markdown rendering for AI responses
if (!isUser) {
    contentDiv.innerHTML = renderMarkdown(content);
} else {
    // For user messages, just show plain text with line breaks
    contentDiv.innerHTML = `<p>${content.replace(/\n/g, '<br>')}</p>`;
}

                if (drugRecommendation && drugRecommendation !== 'null') {
                    const drugDiv = document.createElement('div');
                    drugDiv.className = 'drug-recommendation';
                    drugDiv.innerHTML = `<strong>ðŸ’Š Recommended OTC Medication:</strong> ${drugRecommendation}`;
                    contentDiv.appendChild(drugDiv);
                }

                if (disclaimer && disclaimer !== 'null') {
                    const disclaimerDiv = document.createElement('div');
                    disclaimerDiv.className = 'disclaimer';
                    disclaimerDiv.innerHTML = `<strong>âš ï¸ Important:</strong> ${disclaimer}`;
                    contentDiv.appendChild(disclaimerDiv);
                }

                if (!isUser && !isError) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    actionsDiv.innerHTML = `
                        <button class="action-btn" onclick="copyToClipboard(this)"><i class="fas fa-copy"></i></button>
                        <button class="action-btn"><i class="fas fa-thumbs-up"></i></button>
                        <button class="action-btn"><i class="fas fa-thumbs-down"></i></button>
                    `;
                    contentDiv.appendChild(actionsDiv);
                }
            }

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (saveToHistory && !isTyping && !isError) {
                if (!chatHistoryData[currentChatId]) {
                    chatHistoryData[currentChatId] = {
                        id: currentChatId,
                        title: "New Conversation",
                        date: new Date().toISOString(),
                        messages: []
                    };
                }

                const messageData = {
                    role: isUser ? 'user' : 'ai',
                    content: content,
                    timestamp: new Date().toISOString()
                };

                if (isMedical) messageData.isMedical = true;
                if (drugRecommendation) messageData.drugRecommendation = drugRecommendation;
                if (disclaimer) messageData.disclaimer = disclaimer;

                chatHistoryData[currentChatId].messages.push(messageData);
                if (isUser && chatHistoryData[currentChatId].title === "New Conversation") {
                    const shortMessage = content.length > 30 ? content.substring(0, 30) + '...' : content;
                    chatHistoryData[currentChatId].title = shortMessage;
                    renderChatHistory();
                }
            }
            
            return messageDiv;
        }

        // ============================================
        // AI & VOICE FUNCTIONS
        // ============================================
        async function callBackendAPI(userMessage) {
            try {
                console.log('ðŸŒ [DEBUG] Sending to:', BACKEND_URL);
                
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: userMessage
                    })
                });

                console.log('ðŸ“¥ [DEBUG] Response status:', response.status);
                
                const responseText = await response.text();
                console.log('ðŸ“„ [DEBUG] Raw response:', responseText);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('âœ… [DEBUG] Parsed JSON:', data);
                } catch (parseError) {
                    console.error('âŒ [DEBUG] JSON parse error:', parseError);
                    throw new Error('Invalid JSON from server: ' + responseText);
                }

                return data;

            } catch (error) {
                console.error('âŒ [DEBUG] API call failed:', error);
                throw error;
            }
        }

        async function processUserInput(input) {
            if (!input.trim()) return;

            addMessageToChat(input, true);
            statusIndicator.textContent = "Processing with AI...";

            const typingMessage = addMessageToChat("Analyzing your message...", false, true);

            try {
                const response = await callBackendAPI(input);
                typingMessage.remove();

                addMessageToChat(
                    response.response,
                    false,
                    false,
                    false,
                    response.is_medical,
                    response.drug_recommendation,
                    response.disclaimer
                );

                if (response.translation && response.translation !== "Error processing request") {
                    const translationDiv = document.createElement('div');
                    translationDiv.style.marginTop = '10px';
                    translationDiv.style.fontSize = '0.9rem';
                    translationDiv.style.opacity = '0.8';
                    translationDiv.style.fontStyle = 'italic';
                    translationDiv.textContent = `ðŸ” Translation: "${response.translation}"`;
                    chatContainer.lastChild.querySelector('.message-content').appendChild(translationDiv);
                }

                statusIndicator.textContent = "Response ready";
                speakResponse(response.response);

            } catch (error) {
                typingMessage.remove();
                const errorMessage = `I'm having trouble connecting to the server. Please check your internet connection and try again.\n\nError details: ${error.message}`;

                addMessageToChat(errorMessage, false, false, true);
                statusIndicator.textContent = "Connection error. Please try again.";
                console.error('Processing error:', error);
            }
        }

        function speakResponse(text) {
            if (!audioEnabled) return;

            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        function copyToClipboard(button) {
            const messageContent = button.closest('.message').querySelector('.message-content p').textContent;
            navigator.clipboard.writeText(messageContent).then(() => {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 2000);
            });
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            initializeApp();
            
            // Setup auto verification
            setupAutoVerify();
            
            // Original event listeners
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            newChatBtn.addEventListener('click', createNewChat);

            clearChatBtn.addEventListener('click', () => {
                if (confirm("Are you sure you want to clear this conversation?")) {
                    chatHistoryData[currentChatId].messages = [
                        {
                            role: "ai",
                            content: "Hello! I'm your AI medical assistant. How can I help you today?",
                            timestamp: new Date().toISOString()
                        }
                    ];
                    saveChatHistory();
                    loadChat(currentChatId);
                    statusIndicator.textContent = "Conversation cleared";
                }
            });

            document.getElementById('audioToggleBtn').addEventListener('click', toggleAudioResponses);

            settingsBtn.addEventListener('click', () => {
                settingsMenu.classList.toggle('show');
            });

            document.addEventListener('click', (e) => {
                if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
                    settingsMenu.classList.remove('show');
                }
            });

            document.getElementById('profileSettings').addEventListener('click', () => {
                if (currentUser) {
                    document.getElementById('profileName').value = currentUser.name || currentUser.username || '';
                    document.getElementById('profileEmail').value = currentUser.email || '';
                    profileModal.style.display = 'flex';
                } else {
                    loginModal.style.display = 'flex';
                }
                settingsMenu.classList.remove('show');
            });

            document.getElementById('privacyPolicy').addEventListener('click', () => {
                privacyModal.style.display = 'flex';
                settingsMenu.classList.remove('show');
            });

            document.getElementById('contactUs').addEventListener('click', () => {
                contactModal.style.display = 'flex';
                settingsMenu.classList.remove('show');
            });

            document.getElementById('aboutUs').addEventListener('click', () => {
                aboutModal.style.display = 'flex';
                settingsMenu.classList.remove('show');
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                logoutUser();
                settingsMenu.classList.remove('show');
            });

            userProfile.addEventListener('click', () => {
                if (currentUser) {
                    document.getElementById('profileName').value = currentUser.name || currentUser.username || '';
                    document.getElementById('profileEmail').value = currentUser.email || '';
                    profileModal.style.display = 'flex';
                } else {
                    loginModal.style.display = 'flex';
                }
            });

            // Modal close buttons
            document.getElementById('closeLoginModal').addEventListener('click', () => {
                loginModal.style.display = 'none';
            });
            document.getElementById('closeRegisterModal').addEventListener('click', () => {
                registerModal.style.display = 'none';
            });
            document.getElementById('closeProfileModal').addEventListener('click', () => {
                profileModal.style.display = 'none';
            });
            document.getElementById('closePrivacyModal').addEventListener('click', () => {
                privacyModal.style.display = 'none';
            });
            document.getElementById('closeContactModal').addEventListener('click', () => {
                contactModal.style.display = 'none';
            });
            document.getElementById('closeAboutModal').addEventListener('click', () => {
                aboutModal.style.display = 'none';
            });
            document.getElementById('closeVerificationModal').addEventListener('click', () => {
                verificationModal.style.display = 'none';
                registerModal.style.display = 'flex';
                pendingUser = null;
                verificationCode = '';
            });

            // Modal links
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                loginModal.style.display = 'none';
                registerModal.style.display = 'flex';
            });

            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                registerModal.style.display = 'none';
                loginModal.style.display = 'flex';
            });

            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                loginUser(email, password);
            });

            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;

                if (password !== confirmPassword) {
                    alert("Passwords do not match");
                    return;
                }

                if (password.length < 6) {
                    alert("Password must be at least 6 characters long");
                    return;
                }

                registerUser(name, email, password);
            });

            document.getElementById('updateProfileBtn').addEventListener('click', () => {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                if (newPassword && newPassword !== confirmNewPassword) {
                    alert("New passwords do not match");
                    return;
                }

                updateUserProfile(name, email, currentPassword, newPassword);
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === loginModal) loginModal.style.display = 'none';
                if (e.target === registerModal) registerModal.style.display = 'none';
                if (e.target === profileModal) profileModal.style.display = 'none';
                if (e.target === privacyModal) privacyModal.style.display = 'none';
                if (e.target === contactModal) contactModal.style.display = 'none';
                if (e.target === aboutModal) aboutModal.style.display = 'none';
                if (e.target === verificationModal) {
                    verificationModal.style.display = 'none';
                    registerModal.style.display = 'flex';
                    pendingUser = null;
                }
            });

            console.log(`Frontend configured to connect to: ${BACKEND_URL}`);
            console.log('Make sure your Flask backend is running on the specified URL');
        });
    </script>
</body>
</html>

















